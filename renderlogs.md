2025-09-28T15:09:32.273543491Z ==> Uploading build...
2025-09-28T15:09:52.515381461Z ==> Uploaded in 15.0s. Compression took 5.3s
2025-09-28T15:09:52.613111447Z ==> Build successful 🎉
2025-09-28T15:09:55.38220878Z ==> Deploying...
2025-09-28T15:11:25.268822155Z ==> No open ports detected, continuing to scan...
2025-09-28T15:11:25.491275438Z ==> Docs on specifying a port: https://render.com/docs/web-services#port-binding
2025-09-28T15:11:30.129426357Z ==> Running '  cd backend && python fix_database.py && python run_migrations.py && uvicorn src.main:app --host 0.0.0.0 --port $PORT'
2025-09-28T15:11:36.24494263Z 🔧 Database Fix Script
2025-09-28T15:11:36.24496127Z ==================================================
2025-09-28T15:11:36.24496685Z ✅ Found database URL: postgresql://ai_descriptions_db_user:ijlatK7LezNTw...
2025-09-28T15:11:36.24497069Z ✅ Database connection established
2025-09-28T15:11:36.24497292Z 🔄 Creating subscriptions table...
2025-09-28T15:11:36.24497519Z 🔄 Creating indexes...
2025-09-28T15:11:36.24497739Z 🔄 Creating webhook_events table...
2025-09-28T15:11:36.24497964Z 🔄 Creating transactions table...
2025-09-28T15:11:36.24498246Z 🔄 Creating usage table...
2025-09-28T15:11:36.24498467Z 🔄 Creating user_credits table...
2025-09-28T15:11:36.24498687Z ✅ All tables created successfully!
2025-09-28T15:11:36.244989061Z 🎉 Database fix completed successfully!
2025-09-28T15:11:44.206702716Z INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
2025-09-28T15:11:44.206731537Z INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
2025-09-28T15:11:44.206742297Z INFO  [alembic.runtime.migration] Will assume transactional DDL.
2025-09-28T15:11:44.206746047Z INFO  [alembic.runtime.migration] Will assume transactional DDL.
2025-09-28T15:11:44.421520082Z INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
2025-09-28T15:11:44.421541122Z INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
2025-09-28T15:11:44.421545462Z INFO  [alembic.runtime.migration] Will assume transactional DDL.
2025-09-28T15:11:44.421549422Z INFO  [alembic.runtime.migration] Will assume transactional DDL.
2025-09-28T15:11:44.486977844Z INFO  [alembic.runtime.migration] Running upgrade  -> 0001_initial, initial tables
2025-09-28T15:11:44.486994344Z INFO  [alembic.runtime.migration] Running upgrade  -> 0001_initial, initial tables
2025-09-28T15:11:45.380249603Z 🔄 Checking current database state...
2025-09-28T15:11:45.380269843Z 🔄 Running database migrations...
2025-09-28T15:11:45.380275193Z ⚠️ Migration error: (psycopg2.errors.DuplicateTable) relation "users" already exists
2025-09-28T15:11:45.380282344Z 
2025-09-28T15:11:45.380286273Z [SQL: 
2025-09-28T15:11:45.380290853Z CREATE TABLE users (
2025-09-28T15:11:45.380294964Z 	id VARCHAR NOT NULL, 
2025-09-28T15:11:45.380298714Z 	email VARCHAR, 
2025-09-28T15:11:45.380302754Z 	created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL, 
2025-09-28T15:11:45.380306764Z 	PRIMARY KEY (id)
2025-09-28T15:11:45.380310714Z )
2025-09-28T15:11:45.380314204Z 
2025-09-28T15:11:45.380318054Z ]
2025-09-28T15:11:45.380322204Z (Background on this error at: https://sqlalche.me/e/20/f405)
2025-09-28T15:11:45.380326184Z 🔄 Attempting to continue with existing schema...
2025-09-28T15:11:45.380332364Z ❌ Migration failed: cannot import name 'get_db' from 'src.database.connection' (/opt/render/project/src/backend/src/database/connection.py)
2025-09-28T15:11:45.380336404Z 🔄 Attempting to use simple database initialization...
2025-09-28T15:11:45.380341574Z 🔄 Initializing database...
2025-09-28T15:11:45.380345434Z ✅ Database initialized successfully!
2025-09-28T15:11:45.380349084Z ✅ Database initialized with simple script!
2025-09-28T15:12:16.737669853Z /opt/render/project/src/.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:373: UserWarning: Valid config keys have changed in V2:
2025-09-28T15:12:16.737688513Z * 'schema_extra' has been renamed to 'json_schema_extra'
2025-09-28T15:12:16.737693293Z   warnings.warn(message, UserWarning)
2025-09-28T15:12:16.83469972Z INFO:     Started server process [57]
2025-09-28T15:12:16.834726521Z INFO:     Waiting for application startup.
2025-09-28T15:12:17.631979905Z INFO:     Application startup complete.
2025-09-28T15:12:17.632591003Z INFO:     Uvicorn running on http://0.0.0.0:10000 (Press CTRL+C to quit)
2025-09-28T15:12:18.326432834Z No .env file found at: /opt/render/project/src/backend/.env
2025-09-28T15:12:18.326455105Z Make sure to create a .env file with your GEMINI_API_KEY
2025-09-28T15:12:18.326458895Z ✅ Gemini API key loaded successfully
2025-09-28T15:12:18.326484835Z 📊 Using model: gemini-flash-latest, temperature: 0.8
2025-09-28T15:12:18.326487605Z 💰 Daily cost limit: $1.0, Monthly: $10.0
2025-09-28T15:12:18.326489895Z ✅ Gemini model 'gemini-flash-latest' configured successfully
2025-09-28T15:12:18.326492175Z ✅ AI Product Descriptions API started successfully
2025-09-28T15:12:18.326494495Z 🤖 Model: gemini-flash-latest (Live mode)
2025-09-28T15:12:18.326497435Z 🌡️  Temperature: 0.8
2025-09-28T15:12:18.326499705Z ✅ API key configured - ready for AI generation
2025-09-28T15:12:18.326501825Z 💳 Credit service initialized - rate limiting enabled
2025-09-28T15:12:18.326504105Z 📋 Subscription plans initialized
2025-09-28T15:12:18.326506415Z INFO:     127.0.0.1:60014 - "HEAD / HTTP/1.1" 404 Not Found
2025-09-28T15:12:26.130640911Z ==> Your service is live 🎉
2025-09-28T15:12:26.21684384Z ==> 
2025-09-28T15:12:26.29596779Z ==> ///////////////////////////////////////////////////////////
2025-09-28T15:12:26.382249499Z ==> 
2025-09-28T15:12:26.464206149Z ==> Available at your primary URL https://ai-product-descriptions.onrender.com
2025-09-28T15:12:26.545629338Z ==> 
2025-09-28T15:12:26.626243568Z ==> ///////////////////////////////////////////////////////////
2025-09-28T15:12:28.031666029Z INFO:     35.197.118.178:0 - "GET / HTTP/1.1" 404 Not Found
2025-09-28T15:12:41.861056948Z INFO:     41.238.10.39:0 - "WebSocket /ws/payments" [accepted]
2025-09-28T15:12:41.861381162Z INFO:     connection open
2025-09-28T15:12:44.244976295Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:44.247861623Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:44.64837Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:44.838504923Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:44.838506253Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:45.665169683Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:45.818778183Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:45.823244853Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:47.182237977Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:47.182859195Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:47.185768205Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:47.632996241Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:47.822435554Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:47.825232472Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:48.623700732Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:48.881185132Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:48.884278283Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:49.670504949Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:49.840338967Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:49.843163265Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:50.674329855Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:50.789051731Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:50.791842339Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:51.633035045Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:51.825266835Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:51.828112873Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:52.676583147Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:52.799407382Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:52.802400183Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:53.669870183Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:53.820905728Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:53.823961539Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:55.03136164Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:55.658688584Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:55.66139171Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:56.581888185Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:56.777880715Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:56.780911276Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:56.838857427Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:56.9770902Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:56.980261103Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:57.664627095Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:57.774687208Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:57.777541507Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:58.653645193Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:58.783861798Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:58.879491546Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:12:59.634822555Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:12:59.819902059Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:12:59.822855869Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:00.719862716Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:00.866858857Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:00.869732946Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:01.639058293Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:01.869500559Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:01.872493529Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:02.671944162Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:02.791896058Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:02.795486557Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:03.654248869Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:03.812098036Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:03.815199978Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:04.630322112Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:04.79639447Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:04.799197358Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:05.673936436Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:05.793813661Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:05.7974166Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:07.364139842Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:07.518534543Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:07.521627594Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:08.689848467Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:08.88823324Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:08.980420492Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:09.169623092Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:09.173687716Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:09.6496087Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:09.806725267Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:09.820194088Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:10.003494949Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:10.65291056Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:10.805193372Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:10.808287104Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:11.665173091Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:11.796305578Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:11.799312349Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:12.672492305Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:12.832325899Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:12.83537439Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:13.656148531Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:13.819494262Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:13.825418421Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:14.62899076Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:14.819254684Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:14.822996764Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:15.676537726Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:15.866499586Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:15.869297294Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:16.6489873Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:16.823828116Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:16.826763796Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:17.670988002Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:17.832342656Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:17.835276166Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:18.66156994Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:18.85524398Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:18.85821107Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:19.659345906Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:19.824033575Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:19.827019445Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:20.63776557Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:20.828215086Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:20.831007824Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:21.627512467Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:21.862565334Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:21.865378642Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:22.665031168Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:13:22.828997727Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:13:22.832045868Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:13:24.650963188Z WARNING:root:Invalid auth header format
2025-09-28T15:13:24.651250332Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 401 Unauthorized
2025-09-28T15:17:23.8499523Z ==> Detected service running on port 10000
2025-09-28T15:17:24.044479364Z ==> Docs on specifying a port: https://render.com/docs/web-services#port-binding
2025-09-28T15:19:09.372926376Z INFO:     connection closed
2025-09-28T15:21:16.454640937Z WARNING:root:Invalid auth header format
2025-09-28T15:21:16.454932491Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 401 Unauthorized
2025-09-28T15:21:16.573996946Z INFO:     41.238.10.39:0 - "WebSocket /ws/payments" [accepted]
2025-09-28T15:21:16.574146738Z INFO:     connection open
2025-09-28T15:21:19.770527501Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:19.79479801Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:19.795767143Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:19.804035295Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:19.808712979Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:19.81027358Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:20.023574674Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:20.024172952Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:20.02700089Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:20.053557431Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:20.74937184Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:20.749914417Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:20.752813926Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:21.499195672Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:21.501728937Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:21.540387091Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:21.964102139Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:21.967022239Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:22.828382224Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:22.831265943Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:22.992797005Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:22.995625253Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:23.029525303Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:24.221642495Z ERROR:src.payments.endpoints:Error getting user subscription: This session is in 'prepared' state; no further SQL can be emitted within this transaction.
2025-09-28T15:21:24.221804718Z WARNING:src.database.deps:Rollback failed: Method 'rollback()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-28T15:21:24.221840738Z ERROR:src.database.deps:Database session error: 500: Failed to get user subscription: This session is in 'prepared' state; no further SQL can be emitted within this transaction.
2025-09-28T15:21:24.221919789Z WARNING:src.database.deps:Close failed: Method 'close()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-28T15:21:24.22196649Z WARNING:src.database.deps:Remove from registry failed: Method 'close()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-28T15:21:24.222291734Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 500 Internal Server Error
2025-09-28T15:21:24.223256897Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:24.595642059Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:25.123683262Z ERROR:src.payments.endpoints:Error getting user subscription: This session is in 'prepared' state; no further SQL can be emitted within this transaction.
2025-09-28T15:21:25.123910655Z WARNING:src.database.deps:Rollback failed: Method 'rollback()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-28T15:21:25.123923915Z ERROR:src.database.deps:Database session error: 500: Failed to get user subscription: This session is in 'prepared' state; no further SQL can be emitted within this transaction.
2025-09-28T15:21:25.124031697Z WARNING:src.database.deps:Close failed: Method 'close()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-28T15:21:25.124124468Z WARNING:src.database.deps:Remove from registry failed: Method 'close()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-28T15:21:25.124494823Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 500 Internal Server Error
2025-09-28T15:21:25.125491956Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:25.721261567Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:30.889513749Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:30.890089326Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:30.925978343Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:34.753931782Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:34.757046514Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:34.780935268Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/plans HTTP/1.1" 200 OK
2025-09-28T15:21:34.783897968Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:35.685685552Z WARNING:src.database.deps:Remove from registry failed: Method 'close()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-28T15:21:35.864210803Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:35.864838751Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:35.864996884Z INFO:     41.238.10.39:0 - "GET /api/payment/plans HTTP/1.1" 200 OK
2025-09-28T15:21:35.867306375Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:36.200211501Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:36.222862708Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:36.225671777Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:36.408807911Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:36.409282177Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:36.412192347Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:36.644265425Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:36.647333346Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:36.670093895Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:36.890925671Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:36.892834267Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:36.895527393Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:37.138932386Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:37.141126095Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:37.18131469Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:37.363963088Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:37.38404428Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:37.386016587Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:38.475353095Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:38.487826014Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:38.491361222Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:38.655889454Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:38.987518652Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:42.936118095Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/checkout HTTP/1.1" 200 OK
2025-09-28T15:21:43.553753764Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:43.554063258Z 🎯 STEP 1: CREATE_CHECKOUT ENDPOINT CALLED
2025-09-28T15:21:43.554070988Z Request data: variant_id='1013286' success_url='https://www.productgeniepro.com/billing?success=true' cancel_url='https://www.productgeniepro.com/pricing?cancelled=true'
2025-09-28T15:21:43.554075198Z Variant ID: 1013286
2025-09-28T15:21:43.554079598Z Success URL: https://www.productgeniepro.com/billing?success=true
2025-09-28T15:21:43.554083208Z Cancel URL: https://www.productgeniepro.com/pricing?cancelled=true
2025-09-28T15:21:43.554087158Z 🎯 STEP 2: GETTING CLIENT INFO
2025-09-28T15:21:43.554091238Z Client info: {'ip_address': '41.238.10.39', 'user_agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36', 'correlation_id': '9cf4981b-d9ea-4bd1-b15a-ce8ad2b4870f'}
2025-09-28T15:21:43.554095889Z 🎯 STEP 3: EXTRACTING AUTH DATA
2025-09-28T15:21:43.554099409Z User ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:21:43.554104978Z User email: ziad321hussein@gmail.com
2025-09-28T15:21:43.554110859Z 🎯 STEP 4: VALIDATING USER
2025-09-28T15:21:43.554116569Z ✅ STEP 4 SUCCESS: User validated
2025-09-28T15:21:43.554121859Z 🎯 STEP 5: VALIDATING VARIANT ID
2025-09-28T15:21:43.554130299Z ✅ STEP 5 SUCCESS: Variant ID validated
2025-09-28T15:21:43.554135099Z 🎯 STEP 6: CALLING LEMON_SQUEEZY SERVICE
2025-09-28T15:21:43.554139919Z 🎯 LEMON SQUEEZY PAYLOAD DEBUG 🎯
2025-09-28T15:21:43.554145649Z === VARIABLES ===
2025-09-28T15:21:43.554150949Z Variant ID: 1013286
2025-09-28T15:21:43.554156309Z Store ID: 224253
2025-09-28T15:21:43.554161639Z User ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:21:43.554165279Z User Email: ziad321hussein@gmail.com
2025-09-28T15:21:43.55416891Z Success URL: https://www.productgeniepro.com/billing?success=true
2025-09-28T15:21:43.554172459Z Cancel URL: https://www.productgeniepro.com/pricing?cancelled=true
2025-09-28T15:21:43.554175959Z Test Mode: True
2025-09-28T15:21:43.55417945Z === PAYLOAD BEING SENT ===
2025-09-28T15:21:43.55418493Z {
2025-09-28T15:21:43.55419046Z   "data": {
2025-09-28T15:21:43.55419588Z     "type": "checkouts",
2025-09-28T15:21:43.55420136Z     "attributes": {
2025-09-28T15:21:43.55420682Z       "checkout_options": {
2025-09-28T15:21:43.55421204Z         "embed": false,
2025-09-28T15:21:43.55421712Z         "media": false
2025-09-28T15:21:43.55422234Z       },
2025-09-28T15:21:43.55422783Z       "checkout_data": {
2025-09-28T15:21:43.5542326Z         "email": "ziad321hussein@gmail.com",
2025-09-28T15:21:43.55423615Z         "custom": {
2025-09-28T15:21:43.55424012Z           "user_id": "bpR6MB3823T20EK7BEa3cs2y22u2"
2025-09-28T15:21:43.554243611Z         }
2025-09-28T15:21:43.554247091Z       },
2025-09-28T15:21:43.554250631Z       "product_options": {
2025-09-28T15:21:43.55425418Z         "redirect_url": "https://www.productgeniepro.com/billing?success=true"
2025-09-28T15:21:43.554257731Z       }
2025-09-28T15:21:43.554261231Z     },
2025-09-28T15:21:43.554264691Z     "relationships": {
2025-09-28T15:21:43.554268451Z       "store": {
2025-09-28T15:21:43.554271961Z         "data": {
2025-09-28T15:21:43.554275411Z           "type": "stores",
2025-09-28T15:21:43.554291811Z           "id": "224253"
2025-09-28T15:21:43.554294071Z         }
2025-09-28T15:21:43.554296241Z       },
2025-09-28T15:21:43.554298331Z       "variant": {
2025-09-28T15:21:43.554301631Z         "data": {
2025-09-28T15:21:43.554305121Z           "type": "variants",
2025-09-28T15:21:43.554308361Z           "id": "1013286"
2025-09-28T15:21:43.554311601Z         }
2025-09-28T15:21:43.554314681Z       }
2025-09-28T15:21:43.554318521Z     }
2025-09-28T15:21:43.554321821Z   }
2025-09-28T15:21:43.554325272Z }
2025-09-28T15:21:43.554328721Z === HEADERS ===
2025-09-28T15:21:43.554330892Z {
2025-09-28T15:21:43.554335302Z   "Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI5NGQ1OWNlZi1kYmI4LTRlYTUtYjE3OC1kMjU0MGZjZDY5MTkiLCJqdGkiOiJkOGY2NTljZjdhMzA3ZGNjM2RjNTk4ZjNiMzU4YTk3YTczYzdhNGJkNDg2ZDlkM2JhYTE4OGQ4Y2MxMGU1Zjc5YWQzODJkZTgyYjgxNjRiNiIsImlhdCI6MTc1ODgyNzU5MC41NzYwMjcsIm5iZiI6MTc1ODgyNzU5MC41NzYwMjksImV4cCI6MjA3NDM2MDM5MC41NjA2NzcsInN1YiI6IjU1NzE5NjQiLCJzY29wZXMiOltdfQ.v6DQ8CrPGAovPSiYrv6Y3GkQ3DWHPcC0aAiZ9mP5BsXCwXoz5Kf1OY-fLAHC4ikcmx2RYZuLbSrF_Xxa4mvw2exFnJMsODiiuzItzhdVGUwR89IzbFAD6hcto-w0ERT3gjP781BJ-lxa7pzC4tCADeRhAtMPM7MZ7h7g-0JsRjXyNDrM0ArKoN84kiGHojmPCBomBuXTQ-mC_VQEWn8PKxTbZEem7FoyP4ydK46xYQu-naukuPTOZHRQ44Mdz_16JQ7Cda2pbfJo2osSPGaLTYUKvH0-aF2jlZToxGCPPr8LbPsHo1-96W2D6CBkCF0kFd6BQd0PKw64X-2ywolNwyna51cLKvkZuOHrh2Z8XVG0GONxeo6b1mFzgs8PzSkaPJ5Er_vhcRQVhAolOVmBHcZ61FUUJ208hR1FUVzMHlrTWtcTAi6HUjthHZB2ZL0xrIkDcWQPxG38i8ArAslXFLytqDTU3tePixq0WDHHBnBq8XSbleFoLH8rdc0j4v5KEPoJyXUS7MrHkiJ602WwLFPuczEdkRPvnSNeRKhsSlPkO8SiQFdHZ6VLCGQoEWDvm7SL2U6lmOJ2T1imOAGiTveGoliycICl_HQo29Fk0VFMFVa_jei7HCgdsLArClUHceqfx5UTOsrWxcd8zr75ALBqDzIWT9tpG5ifdTappes",
2025-09-28T15:21:43.554337952Z   "Accept": "application/vnd.api+json",
2025-09-28T15:21:43.554340102Z   "Content-Type": "application/vnd.api+json",
2025-09-28T15:21:43.554342432Z   "Version": "2021-07-07"
2025-09-28T15:21:43.554344482Z }
2025-09-28T15:21:43.554346562Z === API ENDPOINT ===
2025-09-28T15:21:43.554348702Z POST https://api.lemonsqueezy.com/v1/checkouts
2025-09-28T15:21:43.554350892Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:43.555989264Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:43.629000815Z === RESPONSE ===
2025-09-28T15:21:43.629023615Z Status: Unknown
2025-09-28T15:21:43.629027415Z Response: {
2025-09-28T15:21:43.629031345Z   "jsonapi": {
2025-09-28T15:21:43.629035395Z     "version": "1.0"
2025-09-28T15:21:43.629038635Z   },
2025-09-28T15:21:43.629042015Z   "links": {
2025-09-28T15:21:43.629046015Z     "self": "https://api.lemonsqueezy.com/v1/checkouts/bfdbd44f-9860-4d80-b303-7003820e10db"
2025-09-28T15:21:43.629049315Z   },
2025-09-28T15:21:43.629052595Z   "data": {
2025-09-28T15:21:43.629055315Z     "type": "checkouts",
2025-09-28T15:21:43.629058785Z     "id": "bfdbd44f-9860-4d80-b303-7003820e10db",
2025-09-28T15:21:43.629062426Z     "attributes": {
2025-09-28T15:21:43.629066435Z       "store_id": 224253,
2025-09-28T15:21:43.629070106Z       "variant_id": 1013286,
2025-09-28T15:21:43.629073506Z       "custom_price": null,
2025-09-28T15:21:43.629076856Z       "product_options": {
2025-09-28T15:21:43.629080206Z         "name": "",
2025-09-28T15:21:43.629083416Z         "description": "",
2025-09-28T15:21:43.629086836Z         "media": [],
2025-09-28T15:21:43.629091136Z         "redirect_url": "https://www.productgeniepro.com/billing?success=true",
2025-09-28T15:21:43.629095166Z         "receipt_button_text": "",
2025-09-28T15:21:43.629097426Z         "receipt_link_url": "",
2025-09-28T15:21:43.629099626Z         "receipt_thank_you_note": "",
2025-09-28T15:21:43.629115356Z         "enabled_variants": [],
2025-09-28T15:21:43.629117656Z         "confirmation_title": "",
2025-09-28T15:21:43.629119766Z         "confirmation_message": "",
2025-09-28T15:21:43.629122366Z         "confirmation_button_text": ""
2025-09-28T15:21:43.629125406Z       },
2025-09-28T15:21:43.629127576Z       "checkout_options": {
2025-09-28T15:21:43.629130106Z         "embed": false,
2025-09-28T15:21:43.629132216Z         "media": false,
2025-09-28T15:21:43.629134247Z         "logo": true,
2025-09-28T15:21:43.629136496Z         "desc": true,
2025-09-28T15:21:43.629138616Z         "discount": true,
2025-09-28T15:21:43.629140656Z         "skip_trial": false,
2025-09-28T15:21:43.629142767Z         "quantity": 1,
2025-09-28T15:21:43.629144847Z         "subscription_preview": true,
2025-09-28T15:21:43.629146967Z         "locale": "en"
2025-09-28T15:21:43.629149047Z       },
2025-09-28T15:21:43.629151127Z       "checkout_data": {
2025-09-28T15:21:43.629153287Z         "email": "ziad321hussein@gmail.com",
2025-09-28T15:21:43.629155357Z         "name": "",
2025-09-28T15:21:43.629157417Z         "billing_address": [],
2025-09-28T15:21:43.629159497Z         "tax_number": "",
2025-09-28T15:21:43.629161577Z         "discount_code": "",
2025-09-28T15:21:43.629163617Z         "custom": {
2025-09-28T15:21:43.629165717Z           "user_id": "bpR6MB3823T20EK7BEa3cs2y22u2"
2025-09-28T15:21:43.629167797Z         },
2025-09-28T15:21:43.629169907Z         "variant_quantities": []
2025-09-28T15:21:43.629171987Z       },
2025-09-28T15:21:43.629174097Z       "preview": false,
2025-09-28T15:21:43.629176117Z       "expires_at": null,
2025-09-28T15:21:43.629178197Z       "created_at": "2025-09-28T15:21:43.000000Z",
2025-09-28T15:21:43.629180277Z       "updated_at": "2025-09-28T15:21:43.000000Z",
2025-09-28T15:21:43.629182327Z       "test_mode": true,
2025-09-28T15:21:43.629185557Z       "url": "https://product-genie.lemonsqueezy.com/checkout/custom/bfdbd44f-9860-4d80-b303-7003820e10db?signature=7dff8565616397e00e6a06e4e5ca8e6c6d8ef786358cf3b9025ddfff7520d10b"
2025-09-28T15:21:43.629187757Z     },
2025-09-28T15:21:43.629189837Z     "relationships": {
2025-09-28T15:21:43.629191877Z       "store": {
2025-09-28T15:21:43.629193947Z         "links": {
2025-09-28T15:21:43.629197127Z           "related": "https://api.lemonsqueezy.com/v1/checkouts/bfdbd44f-9860-4d80-b303-7003820e10db/store",
2025-09-28T15:21:43.629199807Z           "self": "https://api.lemonsqueezy.com/v1/checkouts/bfdbd44f-9860-4d80-b303-7003820e10db/relationships/store"
2025-09-28T15:21:43.629201887Z         }
2025-09-28T15:21:43.629203927Z       },
2025-09-28T15:21:43.629206007Z       "variant": {
2025-09-28T15:21:43.629208068Z         "links": {
2025-09-28T15:21:43.629210117Z           "related": "https://api.lemonsqueezy.com/v1/checkouts/bfdbd44f-9860-4d80-b303-7003820e10db/variant",
2025-09-28T15:21:43.629212248Z           "self": "https://api.lemonsqueezy.com/v1/checkouts/bfdbd44f-9860-4d80-b303-7003820e10db/relationships/variant"
2025-09-28T15:21:43.629214337Z         }
2025-09-28T15:21:43.629216377Z       }
2025-09-28T15:21:43.629218428Z     },
2025-09-28T15:21:43.629220568Z     "links": {
2025-09-28T15:21:43.629222788Z       "self": "https://api.lemonsqueezy.com/v1/checkouts/bfdbd44f-9860-4d80-b303-7003820e10db"
2025-09-28T15:21:43.629224858Z     }
2025-09-28T15:21:43.629226898Z   }
2025-09-28T15:21:43.629228998Z }
2025-09-28T15:21:43.629231088Z ✅ STEP 6 SUCCESS: Lemon Squeezy service call successful
2025-09-28T15:21:43.629236358Z Result: {'success': True, 'checkout_url': 'https://product-genie.lemonsqueezy.com/checkout/custom/bfdbd44f-9860-4d80-b303-7003820e10db?signature=7dff8565616397e00e6a06e4e5ca8e6c6d8ef786358cf3b9025ddfff7520d10b', 'checkout_id': 'bfdbd44f-9860-4d80-b303-7003820e10db'}
2025-09-28T15:21:43.629242638Z INFO:     41.238.10.39:0 - "POST /api/payment/checkout HTTP/1.1" 200 OK
2025-09-28T15:21:44.056541964Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:21:44.078668145Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:21:44.081560344Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:21:49.373962575Z INFO:     connection closed
2025-09-28T15:22:41.157367335Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:22:41.157123+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:22:41.188182063Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:41.188210504Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:41.188216354Z 
2025-09-28T15:22:41.188239034Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:41.188251254Z [parameters: {'id': 'sub_ziad321hussein_1759072961', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:41.188258374Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:41.188282085Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:22:41.188401316Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:22:41.188179+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072961', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072961', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "173bee2c-1c29-4acb-86ab-1f21c7707cea"}
2025-09-28T15:22:41.188819632Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:41.188840912Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:41.188843272Z 
2025-09-28T15:22:41.188845992Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:41.188848742Z [parameters: {'id': 'sub_ziad321hussein_1759072961', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:41.188851042Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:41.189186737Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:22:41.189196997Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '1985', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643cd6edd7258a-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': 'ee71a083-af31-4983', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_payment_success', 'x-forwarded-for': '18.116.135.47, 104.23.197.55, 10.226.169.130', 'x-forwarded-proto': 'https', 'x-request-start': '1759072961153855', 'x-signature': 'a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423'}
2025-09-28T15:22:41.189208137Z 🎯 BillingService: Processing webhook event_id=a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423
2025-09-28T15:22:41.189211917Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_payment_success', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': '7d6b1489-f5b7-40ab-a5d0-81225f88e8f6'}, 'data': {'type': 'subscription-invoices', 'id': '4587033', 'attributes': {'store_id': 224253, 'subscription_id': 1521113, 'customer_id': 6829303, 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/640236fb-3a3c-4b36-ae00-6aff3eb57a74/subscription-invoice/4587033?expires=1759094561&signature=d3a0674f345e49ec7c92a061d831512a5ccb62054871c287bb9467dce323da83'}, 'created_at': '2025-09-28T15:22:35.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/store', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/store'}}, 'subscription': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/subscription', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/subscription'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/customer'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033'}}}
2025-09-28T15:22:41.189215447Z 🎯 BillingService: Event a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423 is new, processing...
2025-09-28T15:22:41.189218367Z 🎯 BillingService: Event type: subscription_payment_success
2025-09-28T15:22:41.189225987Z 🎯 BillingService: Attributes: {'store_id': 224253, 'subscription_id': 1521113, 'customer_id': 6829303, 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/640236fb-3a3c-4b36-ae00-6aff3eb57a74/subscription-invoice/4587033?expires=1759094561&signature=d3a0674f345e49ec7c92a061d831512a5ccb62054871c287bb9467dce323da83'}, 'created_at': '2025-09-28T15:22:35.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:22:41.189234847Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:22:41.189238418Z 🎯 BillingService: Checking event type 'subscription_payment_success' against subscription events
2025-09-28T15:22:41.189240247Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=False
2025-09-28T15:22:41.189242358Z ⚠️  No variant_id found in webhook data
2025-09-28T15:22:41.189244567Z ⚠️  Defaulting to free plan
2025-09-28T15:22:41.189246868Z 🔄 Updating existing subscription for user ziad321hussein: pro -> free
2025-09-28T15:22:41.189249528Z ✅ Updated subscription for user ziad321hussein: plan=free, status=SubscriptionStatus.active
2025-09-28T15:22:41.189252528Z ✅ Updated Subscription table for user ziad321hussein: plan=free
2025-09-28T15:22:41.189255838Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:41.189258838Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:41.189261228Z 
2025-09-28T15:22:41.189263968Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:41.189267038Z [parameters: {'id': 'sub_ziad321hussein_1759072961', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 41, 181988, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:41.189270238Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:41.189272738Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:22:42.956434554Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:22:42.956194+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:22:42.981670167Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:42.981685897Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:42.981688907Z 
2025-09-28T15:22:42.981692397Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:42.981708747Z [parameters: {'id': 'sub_ziad321hussein_1759072962', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:42.981712207Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:42.981722447Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:22:42.981826459Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:22:42.981628+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072962', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072962', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "cb40fa06-84fd-47ef-9dbb-7eb209bf1507"}
2025-09-28T15:22:42.982109423Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:42.982115533Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:42.982117583Z 
2025-09-28T15:22:42.982121793Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:42.982125623Z [parameters: {'id': 'sub_ziad321hussein_1759072962', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:42.982128293Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:42.982440607Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:22:42.982447597Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3382', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643ce25a833e6e-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': '01c5837c-ed23-473d', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_created', 'x-forwarded-for': '18.116.135.47, 104.23.197.55, 10.226.169.130', 'x-forwarded-proto': 'https', 'x-request-start': '1759072962954262', 'x-signature': '484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916'}
2025-09-28T15:22:42.982451157Z 🎯 BillingService: Processing webhook event_id=484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916
2025-09-28T15:22:42.982475668Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_created', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'a3113c28-0b3e-4f62-a73c-a33d1ee29761'}, 'data': {'type': 'subscriptions', 'id': '1521113', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:22:42.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094562&signature=621210e751c8ba15d46dde814f330406d0c502551331e5d95dcac65dd88b1dd2', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094562&test_mode=1&user=5534177&signature=d8ebc2b97bd697c26e5816fdd7b5f7293f1fa8f11ad6f8344ee032c8e450dccf', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094562&user=5534177&signature=ef7f59c8fcbc69b50f09836110111a9eae79a05c0899e95b99e9f556e54de690'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113'}}}
2025-09-28T15:22:42.982493748Z 🎯 BillingService: Event 484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916 is new, processing...
2025-09-28T15:22:42.982497478Z 🎯 BillingService: Event type: subscription_created
2025-09-28T15:22:42.982515068Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:22:42.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094562&signature=621210e751c8ba15d46dde814f330406d0c502551331e5d95dcac65dd88b1dd2', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094562&test_mode=1&user=5534177&signature=d8ebc2b97bd697c26e5816fdd7b5f7293f1fa8f11ad6f8344ee032c8e450dccf', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094562&user=5534177&signature=ef7f59c8fcbc69b50f09836110111a9eae79a05c0899e95b99e9f556e54de690'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:22:42.982519018Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:22:42.982526688Z 🎯 BillingService: Checking event type 'subscription_created' against subscription events
2025-09-28T15:22:42.982529558Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T15:22:42.982532358Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T15:22:42.982535048Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T15:22:42.982538239Z 🔧 Mapped to plan: pro
2025-09-28T15:22:42.982541488Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T15:22:42.982544628Z 🔄 Updating existing subscription for user ziad321hussein: pro -> pro
2025-09-28T15:22:42.982547539Z ✅ Updated subscription for user ziad321hussein: plan=pro, status=SubscriptionStatus.active
2025-09-28T15:22:42.982550249Z ✅ Updated Subscription table for user ziad321hussein: plan=pro
2025-09-28T15:22:42.982553599Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:42.982556489Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:42.982558999Z 
2025-09-28T15:22:42.982562409Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:42.982565669Z [parameters: {'id': 'sub_ziad321hussein_1759072962', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 42, 977443, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:42.982568869Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:42.982571899Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:22:46.350663208Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:22:46.350386+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:22:46.38325888Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:46.383286111Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:46.383291551Z 
2025-09-28T15:22:46.383298461Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:46.383322901Z [parameters: {'id': 'sub_ziad321hussein_1759072966', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:46.383327621Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:46.383346722Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:22:46.383427773Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:22:46.383220+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072966', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072966', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "bb130d8e-6332-419c-a019-ca14df2c6207"}
2025-09-28T15:22:46.383754607Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:46.383765087Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:46.383767107Z 
2025-09-28T15:22:46.383770527Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:46.383773017Z [parameters: {'id': 'sub_ziad321hussein_1759072966', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:46.383776017Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:46.384083141Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:22:46.384091422Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '1985', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643cf76cf322ce-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': 'f6beeae8-9646-4097', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_payment_success', 'x-forwarded-for': '18.116.135.47, 104.23.243.80, 10.226.170.195', 'x-forwarded-proto': 'https', 'x-request-start': '1759072966349399', 'x-signature': 'a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423'}
2025-09-28T15:22:46.384096342Z 🎯 BillingService: Processing webhook event_id=a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423
2025-09-28T15:22:46.384101222Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_payment_success', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': '7d6b1489-f5b7-40ab-a5d0-81225f88e8f6'}, 'data': {'type': 'subscription-invoices', 'id': '4587033', 'attributes': {'store_id': 224253, 'subscription_id': 1521113, 'customer_id': 6829303, 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/640236fb-3a3c-4b36-ae00-6aff3eb57a74/subscription-invoice/4587033?expires=1759094561&signature=d3a0674f345e49ec7c92a061d831512a5ccb62054871c287bb9467dce323da83'}, 'created_at': '2025-09-28T15:22:35.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/store', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/store'}}, 'subscription': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/subscription', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/subscription'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/customer'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033'}}}
2025-09-28T15:22:46.384111932Z 🎯 BillingService: Event a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423 is new, processing...
2025-09-28T15:22:46.384115082Z 🎯 BillingService: Event type: subscription_payment_success
2025-09-28T15:22:46.384123362Z 🎯 BillingService: Attributes: {'store_id': 224253, 'subscription_id': 1521113, 'customer_id': 6829303, 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/640236fb-3a3c-4b36-ae00-6aff3eb57a74/subscription-invoice/4587033?expires=1759094561&signature=d3a0674f345e49ec7c92a061d831512a5ccb62054871c287bb9467dce323da83'}, 'created_at': '2025-09-28T15:22:35.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:22:46.384128172Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:22:46.384131202Z 🎯 BillingService: Checking event type 'subscription_payment_success' against subscription events
2025-09-28T15:22:46.384134162Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=False
2025-09-28T15:22:46.384138582Z ⚠️  No variant_id found in webhook data
2025-09-28T15:22:46.384142442Z ⚠️  Defaulting to free plan
2025-09-28T15:22:46.384145162Z 🔄 Updating existing subscription for user ziad321hussein: pro -> free
2025-09-28T15:22:46.384147512Z ✅ Updated subscription for user ziad321hussein: plan=free, status=SubscriptionStatus.active
2025-09-28T15:22:46.384150273Z ✅ Updated Subscription table for user ziad321hussein: plan=free
2025-09-28T15:22:46.384155393Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:46.384158502Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:46.384160953Z 
2025-09-28T15:22:46.384164333Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:46.384167513Z [parameters: {'id': 'sub_ziad321hussein_1759072966', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 46, 377358, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:46.384177213Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:46.384180323Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:22:48.118753447Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:22:48.118509+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:22:48.147541728Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:48.147561648Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:48.147565898Z 
2025-09-28T15:22:48.147572129Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:48.147587469Z [parameters: {'id': 'sub_ziad321hussein_1759072968', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:48.147592639Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:48.14768089Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:22:48.147730371Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:22:48.147523+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072968', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072968', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "7dd74776-27a3-40b6-8219-63bfa99a19e3"}
2025-09-28T15:22:48.148075535Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:48.148082465Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:48.148085965Z 
2025-09-28T15:22:48.148089636Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:48.148093456Z [parameters: {'id': 'sub_ziad321hussein_1759072968', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:48.148095905Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:48.148352359Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:22:48.148359729Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3382', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643d02a8aab40c-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': 'cfbea5a3-a9dd-4815', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_created', 'x-forwarded-for': '18.116.135.47, 104.23.197.55, 10.226.169.130', 'x-forwarded-proto': 'https', 'x-request-start': '1759072968116518', 'x-signature': '484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916'}
2025-09-28T15:22:48.148371959Z 🎯 BillingService: Processing webhook event_id=484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916
2025-09-28T15:22:48.148379009Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_created', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'a3113c28-0b3e-4f62-a73c-a33d1ee29761'}, 'data': {'type': 'subscriptions', 'id': '1521113', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:22:42.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094562&signature=621210e751c8ba15d46dde814f330406d0c502551331e5d95dcac65dd88b1dd2', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094562&test_mode=1&user=5534177&signature=d8ebc2b97bd697c26e5816fdd7b5f7293f1fa8f11ad6f8344ee032c8e450dccf', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094562&user=5534177&signature=ef7f59c8fcbc69b50f09836110111a9eae79a05c0899e95b99e9f556e54de690'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113'}}}
2025-09-28T15:22:48.148385969Z 🎯 BillingService: Event 484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916 is new, processing...
2025-09-28T15:22:48.14838886Z 🎯 BillingService: Event type: subscription_created
2025-09-28T15:22:48.14840441Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:22:42.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094562&signature=621210e751c8ba15d46dde814f330406d0c502551331e5d95dcac65dd88b1dd2', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094562&test_mode=1&user=5534177&signature=d8ebc2b97bd697c26e5816fdd7b5f7293f1fa8f11ad6f8344ee032c8e450dccf', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094562&user=5534177&signature=ef7f59c8fcbc69b50f09836110111a9eae79a05c0899e95b99e9f556e54de690'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:22:48.14840915Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:22:48.1484124Z 🎯 BillingService: Checking event type 'subscription_created' against subscription events
2025-09-28T15:22:48.14841614Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T15:22:48.14841984Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T15:22:48.14842344Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T15:22:48.14842727Z 🔧 Mapped to plan: pro
2025-09-28T15:22:48.14843133Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T15:22:48.14843464Z 🔄 Updating existing subscription for user ziad321hussein: pro -> pro
2025-09-28T15:22:48.14843799Z ✅ Updated subscription for user ziad321hussein: plan=pro, status=SubscriptionStatus.active
2025-09-28T15:22:48.14844135Z ✅ Updated Subscription table for user ziad321hussein: plan=pro
2025-09-28T15:22:48.14844537Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:22:48.14844887Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:22:48.14845087Z 
2025-09-28T15:22:48.14845451Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:22:48.148457621Z [parameters: {'id': 'sub_ziad321hussein_1759072968', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 22, 48, 142674, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:22:48.148490741Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:22:48.148495111Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:23:11.541668629Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:23:11.541408+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:23:11.565532772Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:11.565565263Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:11.565570943Z 
2025-09-28T15:23:11.565577843Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:11.565582733Z [parameters: {'id': 'sub_ziad321hussein_1759072991', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:11.565586953Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:11.565601053Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:23:11.565672094Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:23:11.565455+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072991', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072991', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "ed73e7dc-a125-4c34-bd5c-7d2797d56442"}
2025-09-28T15:23:11.566043199Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:11.566052799Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:11.566055659Z 
2025-09-28T15:23:11.566062219Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:11.566066169Z [parameters: {'id': 'sub_ziad321hussein_1759072991', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:11.5660699Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:11.566393254Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:23:11.566400694Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '1985', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643d94ff816e2a-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': 'e02dbd32-fbb1-4a22', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_payment_success', 'x-forwarded-for': '18.116.135.47, 104.23.243.80, 10.226.170.195', 'x-forwarded-proto': 'https', 'x-request-start': '1759072991539814', 'x-signature': 'a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423'}
2025-09-28T15:23:11.566417584Z 🎯 BillingService: Processing webhook event_id=a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423
2025-09-28T15:23:11.566422114Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_payment_success', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': '7d6b1489-f5b7-40ab-a5d0-81225f88e8f6'}, 'data': {'type': 'subscription-invoices', 'id': '4587033', 'attributes': {'store_id': 224253, 'subscription_id': 1521113, 'customer_id': 6829303, 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/640236fb-3a3c-4b36-ae00-6aff3eb57a74/subscription-invoice/4587033?expires=1759094561&signature=d3a0674f345e49ec7c92a061d831512a5ccb62054871c287bb9467dce323da83'}, 'created_at': '2025-09-28T15:22:35.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/store', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/store'}}, 'subscription': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/subscription', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/subscription'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033/relationships/customer'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587033'}}}
2025-09-28T15:23:11.566425134Z 🎯 BillingService: Event a1266d3740e3341e6e5372c15109597e52e225cff8e91aac5dce815f4eea4423 is new, processing...
2025-09-28T15:23:11.566428354Z 🎯 BillingService: Event type: subscription_payment_success
2025-09-28T15:23:11.566445005Z 🎯 BillingService: Attributes: {'store_id': 224253, 'subscription_id': 1521113, 'customer_id': 6829303, 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/640236fb-3a3c-4b36-ae00-6aff3eb57a74/subscription-invoice/4587033?expires=1759094561&signature=d3a0674f345e49ec7c92a061d831512a5ccb62054871c287bb9467dce323da83'}, 'created_at': '2025-09-28T15:22:35.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:23:11.566449735Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:23:11.566476155Z 🎯 BillingService: Checking event type 'subscription_payment_success' against subscription events
2025-09-28T15:23:11.566486245Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=False
2025-09-28T15:23:11.566489035Z ⚠️  No variant_id found in webhook data
2025-09-28T15:23:11.566492575Z ⚠️  Defaulting to free plan
2025-09-28T15:23:11.566495545Z 🔄 Updating existing subscription for user ziad321hussein: pro -> free
2025-09-28T15:23:11.566498105Z ✅ Updated subscription for user ziad321hussein: plan=free, status=SubscriptionStatus.active
2025-09-28T15:23:11.566500975Z ✅ Updated Subscription table for user ziad321hussein: plan=free
2025-09-28T15:23:11.566504415Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:11.566507326Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:11.566510106Z 
2025-09-28T15:23:11.566514975Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:11.566519326Z [parameters: {'id': 'sub_ziad321hussein_1759072991', 'user_id': 'ziad321hussein', 'plan_id': 'free', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 11, 561594, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:11.566522406Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:11.566525296Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:23:12.147671737Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:23:12.145445+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:23:12.194611933Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:23:12.194641934Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3382', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643d98bf6d1709-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': '59ed9ccc-7085-489d', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_updated', 'x-forwarded-for': '18.116.135.47, 104.23.197.55, 10.226.169.130', 'x-forwarded-proto': 'https', 'x-request-start': '1759072992136299', 'x-signature': 'd9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc'}
2025-09-28T15:23:12.194646654Z 🎯 BillingService: Processing webhook event_id=d9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc
2025-09-28T15:23:12.194665464Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_updated', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'e2b133a8-308a-4f3e-a487-e58f08212297'}, 'data': {'type': 'subscriptions', 'id': '1521113', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:23:11.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094592&signature=6822e7bbb64b38c033d3c127f170deda04e8d3f4c979c4cdc0a96890e686965c', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094592&test_mode=1&user=5534177&signature=73af8aa4ac0199adb676a831cd51e8b524c41add007434cb619f4f345cf25d1f', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094592&user=5534177&signature=d8912e1ff3c4dcdeae7b7fdede9cecb336f59a997694aa19fe6137faa03d7c30'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113'}}}
2025-09-28T15:23:12.194669244Z 🎯 BillingService: Event d9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc is new, processing...
2025-09-28T15:23:12.194673604Z 🎯 BillingService: Event type: subscription_updated
2025-09-28T15:23:12.194679044Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:23:11.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094592&signature=6822e7bbb64b38c033d3c127f170deda04e8d3f4c979c4cdc0a96890e686965c', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094592&test_mode=1&user=5534177&signature=73af8aa4ac0199adb676a831cd51e8b524c41add007434cb619f4f345cf25d1f', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094592&user=5534177&signature=d8912e1ff3c4dcdeae7b7fdede9cecb336f59a997694aa19fe6137faa03d7c30'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:23:12.194688034Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:23:12.194690734Z 🎯 BillingService: Checking event type 'subscription_updated' against subscription events
2025-09-28T15:23:12.194694334Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T15:23:12.194696774Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T15:23:12.194699505Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T15:23:12.194703334Z 🔧 Mapped to plan: pro
2025-09-28T15:23:12.194707545Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T15:23:12.194710045Z 🔄 Updating existing subscription for user ziad321hussein: pro -> pro
2025-09-28T15:23:12.194712275Z ✅ Updated subscription for user ziad321hussein: plan=pro, status=SubscriptionStatus.active
2025-09-28T15:23:12.194714545Z ✅ Updated Subscription table for user ziad321hussein: plan=pro
2025-09-28T15:23:12.194718345Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:12.194720825Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:12.194722765Z 
2025-09-28T15:23:12.194737435Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:12.194741485Z [parameters: {'id': 'sub_ziad321hussein_1759072992', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:12.194743995Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:12.194817936Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:23:12.194875457Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:12.194880587Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:12.194883147Z 
2025-09-28T15:23:12.194886177Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:12.194889417Z [parameters: {'id': 'sub_ziad321hussein_1759072992', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:12.194892687Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:12.194895217Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:23:12.195241952Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:23:12.190360+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072992', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072992', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "91c8760a-1f8d-4044-8538-047f7b24c1aa"}
2025-09-28T15:23:12.200614574Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:12.200621665Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:12.200624085Z 
2025-09-28T15:23:12.200627725Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:12.200644445Z [parameters: {'id': 'sub_ziad321hussein_1759072992', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 12, 182982, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:12.200647745Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:13.28276979Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:23:13.282529+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:23:13.314774964Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:13.314803224Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:13.314806504Z 
2025-09-28T15:23:13.314812084Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:13.314817604Z [parameters: {'id': 'sub_ziad321hussein_1759072993', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:13.314836865Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:13.314854055Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:23:13.315025407Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:23:13.314731+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072993', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072993', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "511e8d18-5ac9-4422-a909-7e8a6387a4f8"}
2025-09-28T15:23:13.315528304Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:13.315554585Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:13.315559045Z 
2025-09-28T15:23:13.315564555Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:13.315569515Z [parameters: {'id': 'sub_ziad321hussein_1759072993', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:13.315574115Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:13.315918779Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:23:13.31593075Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3382', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643d9fe98d70f3-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': '31bf0eaa-e88a-4f7a', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_created', 'x-forwarded-for': '18.116.135.47, 104.23.243.80, 10.226.170.195', 'x-forwarded-proto': 'https', 'x-request-start': '1759072993281814', 'x-signature': '484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916'}
2025-09-28T15:23:13.31593484Z 🎯 BillingService: Processing webhook event_id=484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916
2025-09-28T15:23:13.31594246Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_created', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'a3113c28-0b3e-4f62-a73c-a33d1ee29761'}, 'data': {'type': 'subscriptions', 'id': '1521113', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:22:42.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094562&signature=621210e751c8ba15d46dde814f330406d0c502551331e5d95dcac65dd88b1dd2', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094562&test_mode=1&user=5534177&signature=d8ebc2b97bd697c26e5816fdd7b5f7293f1fa8f11ad6f8344ee032c8e450dccf', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094562&user=5534177&signature=ef7f59c8fcbc69b50f09836110111a9eae79a05c0899e95b99e9f556e54de690'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113'}}}
2025-09-28T15:23:13.31595362Z 🎯 BillingService: Event 484f9f50fab11ea1a811ee1f61605e1e312cb1cc897e17e2d7d6e3a0097ea916 is new, processing...
2025-09-28T15:23:13.31595673Z 🎯 BillingService: Event type: subscription_created
2025-09-28T15:23:13.31596449Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:22:42.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094562&signature=621210e751c8ba15d46dde814f330406d0c502551331e5d95dcac65dd88b1dd2', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094562&test_mode=1&user=5534177&signature=d8ebc2b97bd697c26e5816fdd7b5f7293f1fa8f11ad6f8344ee032c8e450dccf', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094562&user=5534177&signature=ef7f59c8fcbc69b50f09836110111a9eae79a05c0899e95b99e9f556e54de690'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:23:13.31596816Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:23:13.31597116Z 🎯 BillingService: Checking event type 'subscription_created' against subscription events
2025-09-28T15:23:13.31597398Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T15:23:13.31597648Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T15:23:13.315988931Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T15:23:13.3159923Z 🔧 Mapped to plan: pro
2025-09-28T15:23:13.315995771Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T15:23:13.315998291Z 🔄 Updating existing subscription for user ziad321hussein: pro -> pro
2025-09-28T15:23:13.316000931Z ✅ Updated subscription for user ziad321hussein: plan=pro, status=SubscriptionStatus.active
2025-09-28T15:23:13.316003791Z ✅ Updated Subscription table for user ziad321hussein: plan=pro
2025-09-28T15:23:13.316006851Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:13.316009501Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:13.316012151Z 
2025-09-28T15:23:13.316014871Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:13.316018171Z [parameters: {'id': 'sub_ziad321hussein_1759072993', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 13, 304887, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:13.316021291Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:13.316024231Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:23:16.192150544Z INFO:     41.238.10.39:0 - "WebSocket /ws/payments" [accepted]
2025-09-28T15:23:16.192313257Z INFO:     connection open
2025-09-28T15:23:16.446425272Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:16.446804337Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:16.448940786Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:17.321245006Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:23:17.321007+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:23:17.353087547Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:17.353113107Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:17.353115678Z 
2025-09-28T15:23:17.353119848Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:17.353138088Z [parameters: {'id': 'sub_ziad321hussein_1759072997', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:17.353141558Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:17.353155728Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:23:17.353236189Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:23:17.353036+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072997', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759072997', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "4dce94ad-09bd-45f4-937b-cbeee2df6c27"}
2025-09-28T15:23:17.353650125Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:17.353661905Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:17.353665595Z 
2025-09-28T15:23:17.353670575Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:17.353673185Z [parameters: {'id': 'sub_ziad321hussein_1759072997', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:17.353675475Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:17.353958429Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:23:17.353965859Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3382', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643db929b12780-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': '7ee02b75-8456-4b1a', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_updated', 'x-forwarded-for': '18.116.135.47, 104.23.243.80, 10.226.170.195', 'x-forwarded-proto': 'https', 'x-request-start': '1759072997320614', 'x-signature': 'd9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc'}
2025-09-28T15:23:17.353969359Z 🎯 BillingService: Processing webhook event_id=d9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc
2025-09-28T15:23:17.353977159Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_updated', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'e2b133a8-308a-4f3e-a487-e58f08212297'}, 'data': {'type': 'subscriptions', 'id': '1521113', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:23:11.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094592&signature=6822e7bbb64b38c033d3c127f170deda04e8d3f4c979c4cdc0a96890e686965c', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094592&test_mode=1&user=5534177&signature=73af8aa4ac0199adb676a831cd51e8b524c41add007434cb619f4f345cf25d1f', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094592&user=5534177&signature=d8912e1ff3c4dcdeae7b7fdede9cecb336f59a997694aa19fe6137faa03d7c30'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113'}}}
2025-09-28T15:23:17.35398867Z 🎯 BillingService: Event d9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc is new, processing...
2025-09-28T15:23:17.353991759Z 🎯 BillingService: Event type: subscription_updated
2025-09-28T15:23:17.353996739Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:23:11.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094592&signature=6822e7bbb64b38c033d3c127f170deda04e8d3f4c979c4cdc0a96890e686965c', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094592&test_mode=1&user=5534177&signature=73af8aa4ac0199adb676a831cd51e8b524c41add007434cb619f4f345cf25d1f', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094592&user=5534177&signature=d8912e1ff3c4dcdeae7b7fdede9cecb336f59a997694aa19fe6137faa03d7c30'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:23:17.35400332Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:23:17.35400593Z 🎯 BillingService: Checking event type 'subscription_updated' against subscription events
2025-09-28T15:23:17.35400859Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T15:23:17.35401147Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T15:23:17.35401656Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T15:23:17.35402087Z 🔧 Mapped to plan: pro
2025-09-28T15:23:17.35402489Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T15:23:17.3540282Z 🔄 Updating existing subscription for user ziad321hussein: pro -> pro
2025-09-28T15:23:17.35403125Z ✅ Updated subscription for user ziad321hussein: plan=pro, status=SubscriptionStatus.active
2025-09-28T15:23:17.35403462Z ✅ Updated Subscription table for user ziad321hussein: plan=pro
2025-09-28T15:23:17.35403839Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:17.35404194Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:17.35404558Z 
2025-09-28T15:23:17.35404917Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:17.35405267Z [parameters: {'id': 'sub_ziad321hussein_1759072997', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 17, 347580, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:17.35405504Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:17.35405736Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:23:17.584498725Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:17.730706108Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:17.733165261Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:17.9387746Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:17.941674439Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:18.001987777Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:18.141239525Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:18.143875591Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:18.189635142Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:18.361083947Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:18.363252106Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:18.412163479Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:19.871152074Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:20.107626291Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:20.147670514Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:20.15026455Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:20.290719304Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:20.739171546Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:20.741198473Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:20.84719406Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:21.133608794Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:21.136426813Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:21.24981262Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:21.788282443Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:21.79102054Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:21.925146978Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:23.38090068Z INFO:     41.238.10.39:0 - "GET /api/payment/plans HTTP/1.1" 200 OK
2025-09-28T15:23:23.576264389Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:23.578877754Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:23.676708601Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:24.00775121Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:24.00993808Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:24.129092505Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:25.984127441Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:25.987822861Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:26.206515206Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:27.596314872Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:27.59910931Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:27.653495498Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:37.426934059Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:37.428959257Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:38.394362477Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:40.698028813Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:40.795771788Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:40.797616263Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:40.960515642Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:40.968663833Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:41.707639503Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:42.509334744Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T15:23:42.509114+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T15:23:42.537851441Z ERROR:src.payments.endpoints:Error processing webhook: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:42.537878631Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:42.537882861Z 
2025-09-28T15:23:42.537890421Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:42.537896361Z [parameters: {'id': 'sub_ziad321hussein_1759073022', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:42.537900732Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:42.537910432Z ERROR:src.payments.security:AUDIT: webhook_verification_failed - User: None - Success: False - Security Level: critical - IP: 18.116.135.47
2025-09-28T15:23:42.538008293Z WARNING:security:{"event_type": "webhook_verification_failed", "user_id": null, "timestamp": "2025-09-28T15:23:42.537821+00:00", "ip_address": "18.116.135.47", "user_agent": "LemonSqueezy-Hookshot", "event_data": {"error": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759073022', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}, "security_level": "critical", "success": false, "error_message": "(psycopg2.errors.ForeignKeyViolation) insert or update on table \"user_subscriptions\" violates foreign key constraint \"user_subscriptions_user_id_fkey\"\nDETAIL:  Key (user_id)=(ziad321hussein) is not present in table \"users\".\n\n[SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]\n[parameters: {'id': 'sub_ziad321hussein_1759073022', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "session_id": null, "correlation_id": "bec0d094-495c-4273-8ca2-be2778994b55"}
2025-09-28T15:23:42.538362598Z ERROR:src.database.deps:Database session error: 500: Webhook processing failed: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:42.538371388Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:42.538375058Z 
2025-09-28T15:23:42.538379758Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:42.538384308Z [parameters: {'id': 'sub_ziad321hussein_1759073022', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:42.538388128Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:42.538701052Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T15:23:42.538715132Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3382', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '98643e568e7ed319-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': 'd165284d-4b4a-4aa0', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_updated', 'x-forwarded-for': '18.116.135.47, 104.23.197.55, 10.226.169.130', 'x-forwarded-proto': 'https', 'x-request-start': '1759073022507228', 'x-signature': 'd9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc'}
2025-09-28T15:23:42.538730743Z 🎯 BillingService: Processing webhook event_id=d9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc
2025-09-28T15:23:42.538737093Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_updated', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'e2b133a8-308a-4f3e-a487-e58f08212297'}, 'data': {'type': 'subscriptions', 'id': '1521113', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:23:11.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094592&signature=6822e7bbb64b38c033d3c127f170deda04e8d3f4c979c4cdc0a96890e686965c', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094592&test_mode=1&user=5534177&signature=73af8aa4ac0199adb676a831cd51e8b524c41add007434cb619f4f345cf25d1f', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094592&user=5534177&signature=d8912e1ff3c4dcdeae7b7fdede9cecb336f59a997694aa19fe6137faa03d7c30'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521113'}}}
2025-09-28T15:23:42.538743743Z 🎯 BillingService: Event d9446a18ec5429121d7af28224cb211f3ae3b61245f6645b4fe0143dbef44ebc is new, processing...
2025-09-28T15:23:42.538746513Z 🎯 BillingService: Event type: subscription_updated
2025-09-28T15:23:42.538751833Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492342, 'order_item_id': 6436178, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': '', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4511075, 'subscription_id': 1521113, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T15:22:42.000000Z', 'updated_at': '2025-09-28T15:23:11.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521113/payment-details?expires=1759094592&signature=6822e7bbb64b38c033d3c127f170deda04e8d3f4c979c4cdc0a96890e686965c', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759094592&test_mode=1&user=5534177&signature=73af8aa4ac0199adb676a831cd51e8b524c41add007434cb619f4f345cf25d1f', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521113/update?expires=1759094592&user=5534177&signature=d8912e1ff3c4dcdeae7b7fdede9cecb336f59a997694aa19fe6137faa03d7c30'}, 'renews_at': '2025-10-28T15:22:32.000000Z', 'ends_at': None, 'created_at': '2025-09-28T15:22:34.000000Z', 'updated_at': '2025-09-28T15:22:40.000000Z', 'test_mode': True}
2025-09-28T15:23:42.538754993Z 🔄 Found existing user with email ziad321hussein@gmail.com, using ID: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T15:23:42.538757133Z 🎯 BillingService: Checking event type 'subscription_updated' against subscription events
2025-09-28T15:23:42.538759813Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T15:23:42.538761813Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T15:23:42.538763903Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T15:23:42.538766593Z 🔧 Mapped to plan: pro
2025-09-28T15:23:42.538769703Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T15:23:42.538773103Z 🔄 Updating existing subscription for user ziad321hussein: pro -> pro
2025-09-28T15:23:42.538776783Z ✅ Updated subscription for user ziad321hussein: plan=pro, status=SubscriptionStatus.active
2025-09-28T15:23:42.538780513Z ✅ Updated Subscription table for user ziad321hussein: plan=pro
2025-09-28T15:23:42.538784884Z ❌ Error updating subscription tables for user ziad321hussein: (psycopg2.errors.ForeignKeyViolation) insert or update on table "user_subscriptions" violates foreign key constraint "user_subscriptions_user_id_fkey"
2025-09-28T15:23:42.538788333Z DETAIL:  Key (user_id)=(ziad321hussein) is not present in table "users".
2025-09-28T15:23:42.538791204Z 
2025-09-28T15:23:42.538795694Z [SQL: INSERT INTO user_subscriptions (id, user_id, plan_id, status, current_period_start, current_period_end, cancel_at_period_end, lemon_squeezy_subscription_id, lemon_squeezy_customer_id, trial_start, trial_end, subscription_metadata) VALUES (%(id)s, %(user_id)s, %(plan_id)s, %(status)s, %(current_period_start)s, %(current_period_end)s, %(cancel_at_period_end)s, %(lemon_squeezy_subscription_id)s, %(lemon_squeezy_customer_id)s, %(trial_start)s, %(trial_end)s, %(subscription_metadata)s::JSON) RETURNING user_subscriptions.created_at, user_subscriptions.updated_at]
2025-09-28T15:23:42.538806494Z [parameters: {'id': 'sub_ziad321hussein_1759073022', 'user_id': 'ziad321hussein', 'plan_id': 'pro', 'status': 'active', 'current_period_start': datetime.datetime(2025, 9, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'current_period_end': datetime.datetime(2025, 10, 28, 15, 23, 42, 532450, tzinfo=datetime.timezone.utc), 'cancel_at_period_end': False, 'lemon_squeezy_subscription_id': None, 'lemon_squeezy_customer_id': None, 'trial_start': None, 'trial_end': None, 'subscription_metadata': '{}'}]
2025-09-28T15:23:42.538810204Z (Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-28T15:23:42.538813524Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 500 Internal Server Error
2025-09-28T15:23:47.130366064Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:47.133137401Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:47.166881069Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:48.991991366Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:48.992391842Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:48.994962447Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:49.247914077Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:49.269173265Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:49.271804181Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:49.477840474Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:49.480985667Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:49.677432181Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:49.677868176Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:49.680490282Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:49.877573995Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T15:23:49.891357431Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:49.893280717Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:50.09629305Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T15:23:50.099066198Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T15:23:50.720811118Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK