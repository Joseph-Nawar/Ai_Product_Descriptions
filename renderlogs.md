2025-09-27T18:27:58.303030178Z Collecting deprecated>=1.2 (from limits>=2.3->slowapi>=0.1.9->-r requirements.txt (line 24))
2025-09-27T18:27:58.304141118Z   Using cached Deprecated-1.2.18-py2.py3-none-any.whl.metadata (5.7 kB)
2025-09-27T18:27:58.567590896Z Collecting wrapt<2,>=1.10 (from deprecated>=1.2->limits>=2.3->slowapi>=0.1.9->-r requirements.txt (line 24))
2025-09-27T18:27:58.620054495Z   Using cached wrapt-1.17.3-cp313-cp313-manylinux1_x86_64.manylinux_2_28_x86_64.manylinux_2_5_x86_64.whl.metadata (6.4 kB)
2025-09-27T18:27:58.863319704Z Collecting psycopg-binary==3.2.10 (from psycopg[binary]>=3.1.0->-r requirements.txt (line 18))
2025-09-27T18:27:58.864555777Z   Using cached psycopg_binary-3.2.10-cp313-cp313-manylinux2014_x86_64.manylinux_2_17_x86_64.whl.metadata (3.0 kB)
2025-09-27T18:27:59.174677453Z Collecting cryptography>=3.4.0 (from pyjwt[crypto]>=2.10.1->firebase-admin>=7.0.0->-r requirements.txt (line 11))
2025-09-27T18:27:59.176034073Z   Using cached cryptography-46.0.1-cp311-abi3-manylinux_2_34_x86_64.whl.metadata (5.7 kB)
2025-09-27T18:27:59.434737743Z Collecting cffi>=2.0.0 (from cryptography>=3.4.0->pyjwt[crypto]>=2.10.1->firebase-admin>=7.0.0->-r requirements.txt (line 11))
2025-09-27T18:27:59.43615184Z   Using cached cffi-2.0.0-cp313-cp313-manylinux2014_x86_64.manylinux_2_17_x86_64.whl.metadata (2.6 kB)
2025-09-27T18:27:59.550669718Z Collecting pycparser (from cffi>=2.0.0->cryptography>=3.4.0->pyjwt[crypto]>=2.10.1->firebase-admin>=7.0.0->-r requirements.txt (line 11))
2025-09-27T18:27:59.551841801Z   Using cached pycparser-2.23-py3-none-any.whl.metadata (993 bytes)
2025-09-27T18:27:59.792574707Z Collecting six>=1.5 (from python-dateutil>=2.8.2->pandas>=1.5.0->-r requirements.txt (line 7))
2025-09-27T18:27:59.793910205Z   Using cached six-1.17.0-py2.py3-none-any.whl.metadata (1.7 kB)
2025-09-27T18:27:59.88910763Z Collecting httplib2<1.0.0,>=0.19.0 (from google-api-python-client->google-generativeai>=0.3.0->-r requirements.txt (line 5))
2025-09-27T18:27:59.890346809Z   Using cached httplib2-0.31.0-py3-none-any.whl.metadata (2.2 kB)
2025-09-27T18:27:59.942989988Z Collecting google-auth-httplib2<1.0.0,>=0.2.0 (from google-api-python-client->google-generativeai>=0.3.0->-r requirements.txt (line 5))
2025-09-27T18:27:59.944187784Z   Using cached google_auth_httplib2-0.2.0-py2.py3-none-any.whl.metadata (2.2 kB)
2025-09-27T18:27:59.973039568Z Collecting uritemplate<5,>=3.0.1 (from google-api-python-client->google-generativeai>=0.3.0->-r requirements.txt (line 5))
2025-09-27T18:27:59.974249524Z   Using cached uritemplate-4.2.0-py3-none-any.whl.metadata (2.6 kB)
2025-09-27T18:28:00.041041628Z Collecting pyparsing<4,>=3.0.4 (from httplib2<1.0.0,>=0.19.0->google-api-python-client->google-generativeai>=0.3.0->-r requirements.txt (line 5))
2025-09-27T18:28:00.042279226Z   Using cached pyparsing-3.2.5-py3-none-any.whl.metadata (5.0 kB)
2025-09-27T18:28:00.124909186Z Collecting MarkupSafe>=0.9.2 (from Mako->alembic>=1.13.0->-r requirements.txt (line 17))
2025-09-27T18:28:00.129602164Z   Using cached MarkupSafe-3.0.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (4.0 kB)
2025-09-27T18:28:00.138595703Z Using cached fastapi-0.117.1-py3-none-any.whl (95 kB)
2025-09-27T18:28:00.139796677Z Using cached pydantic-2.11.9-py3-none-any.whl (444 kB)
2025-09-27T18:28:00.141232084Z Using cached pydantic_core-2.33.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (2.0 MB)
2025-09-27T18:28:00.14380775Z Using cached starlette-0.48.0-py3-none-any.whl (73 kB)
2025-09-27T18:28:00.144946189Z Using cached anyio-4.11.0-py3-none-any.whl (109 kB)
2025-09-27T18:28:00.146080827Z Using cached uvicorn-0.37.0-py3-none-any.whl (67 kB)
2025-09-27T18:28:00.147166031Z Using cached python_multipart-0.0.20-py3-none-any.whl (24 kB)
2025-09-27T18:28:00.148216351Z Using cached google_generativeai-0.8.5-py3-none-any.whl (155 kB)
2025-09-27T18:28:00.149408255Z Using cached google_ai_generativelanguage-0.6.15-py3-none-any.whl (1.3 MB)
2025-09-27T18:28:00.151508215Z Using cached google_api_core-2.25.1-py3-none-any.whl (160 kB)
2025-09-27T18:28:00.152676227Z Using cached google_auth-2.40.3-py2.py3-none-any.whl (216 kB)
2025-09-27T18:28:00.15386121Z Using cached cachetools-5.5.2-py3-none-any.whl (10 kB)
2025-09-27T18:28:00.154920071Z Using cached googleapis_common_protos-1.70.0-py3-none-any.whl (294 kB)
2025-09-27T18:28:00.156192313Z Using cached grpcio-1.75.1-cp313-cp313-manylinux2014_x86_64.manylinux_2_17_x86_64.whl (6.4 MB)
2025-09-27T18:28:00.162206827Z Using cached grpcio_status-1.71.2-py3-none-any.whl (14 kB)
2025-09-27T18:28:00.163271359Z Using cached proto_plus-1.26.1-py3-none-any.whl (50 kB)
2025-09-27T18:28:00.164345761Z Using cached protobuf-5.29.5-cp38-abi3-manylinux2014_x86_64.whl (319 kB)
2025-09-27T18:28:00.165628764Z Using cached requests-2.32.5-py3-none-any.whl (64 kB)
2025-09-27T18:28:00.166725999Z Using cached charset_normalizer-3.4.3-cp313-cp313-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl (151 kB)
2025-09-27T18:28:00.16788863Z Using cached idna-3.10-py3-none-any.whl (70 kB)
2025-09-27T18:28:00.168980724Z Using cached rsa-4.9.1-py3-none-any.whl (34 kB)
2025-09-27T18:28:00.18265836Z Using cached typing_extensions-4.15.0-py3-none-any.whl (44 kB)
2025-09-27T18:28:00.183727942Z Using cached urllib3-2.5.0-py3-none-any.whl (129 kB)
2025-09-27T18:28:00.184971661Z Using cached python_dotenv-1.1.1-py3-none-any.whl (20 kB)
2025-09-27T18:28:00.186088377Z Using cached pandas-2.3.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (12.1 MB)
2025-09-27T18:28:00.195792334Z Using cached tenacity-9.1.2-py3-none-any.whl (28 kB)
2025-09-27T18:28:00.196953945Z Using cached tqdm-4.67.1-py3-none-any.whl (78 kB)
2025-09-27T18:28:00.198102454Z Using cached rapidfuzz-3.14.1-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl (3.2 MB)
2025-09-27T18:28:00.201526871Z Using cached firebase_admin-7.1.0-py3-none-any.whl (137 kB)
2025-09-27T18:28:00.203066508Z Using cached httpx-0.28.1-py3-none-any.whl (73 kB)
2025-09-27T18:28:00.204376453Z Using cached h2-4.3.0-py3-none-any.whl (61 kB)
2025-09-27T18:28:00.205695989Z Using cached hpack-4.1.0-py3-none-any.whl (34 kB)
2025-09-27T18:28:00.207056669Z Using cached httpcore-1.0.9-py3-none-any.whl (78 kB)
2025-09-27T18:28:00.208267095Z Using cached hyperframe-6.1.0-py3-none-any.whl (13 kB)
2025-09-27T18:28:00.209423075Z Using cached sqlalchemy-2.0.43-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.3 MB)
2025-09-27T18:28:00.212943471Z Using cached alembic-1.16.5-py3-none-any.whl (247 kB)
2025-09-27T18:28:00.214232014Z Using cached psycopg-3.2.10-py3-none-any.whl (206 kB)
2025-09-27T18:28:00.215467962Z Using cached psycopg2_binary-2.9.10-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.0 MB)
2025-09-27T18:28:00.218824723Z Using cached pymysql-1.1.2-py3-none-any.whl (45 kB)
2025-09-27T18:28:00.219991284Z Using cached structlog-25.4.0-py3-none-any.whl (68 kB)
2025-09-27T18:28:00.221111051Z Using cached slowapi-0.1.9-py3-none-any.whl (14 kB)
2025-09-27T18:28:00.238830403Z Using cached sentry_sdk-2.39.0-py2.py3-none-any.whl (370 kB)
2025-09-27T18:28:00.242952857Z Using cached pytest-8.4.2-py3-none-any.whl (365 kB)
2025-09-27T18:28:00.244292614Z Using cached pluggy-1.6.0-py3-none-any.whl (20 kB)
2025-09-27T18:28:00.245419712Z Using cached pytest_cov-7.0.0-py3-none-any.whl (22 kB)
2025-09-27T18:28:00.246475703Z Using cached pytest_asyncio-1.2.0-py3-none-any.whl (15 kB)
2025-09-27T18:28:00.247549385Z Using cached annotated_types-0.7.0-py3-none-any.whl (13 kB)
2025-09-27T18:28:00.24864264Z Using cached cachecontrol-0.14.3-py3-none-any.whl (21 kB)
2025-09-27T18:28:00.249706261Z Using cached msgpack-1.1.1-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (423 kB)
2025-09-27T18:28:00.251088113Z Using cached certifi-2025.8.3-py3-none-any.whl (161 kB)
2025-09-27T18:28:00.252234163Z Using cached click-8.3.0-py3-none-any.whl (107 kB)
2025-09-27T18:28:00.253391803Z Using cached coverage-7.10.7-cp313-cp313-manylinux1_x86_64.manylinux_2_28_x86_64.manylinux_2_5_x86_64.whl (252 kB)
2025-09-27T18:28:00.25461938Z Using cached google_cloud_firestore-2.21.0-py3-none-any.whl (368 kB)
2025-09-27T18:28:00.25597488Z Using cached google_cloud_core-2.4.3-py2.py3-none-any.whl (29 kB)
2025-09-27T18:28:00.257095987Z Using cached google_cloud_storage-3.4.0-py3-none-any.whl (278 kB)
2025-09-27T18:28:00.258432284Z Using cached google_crc32c-1.7.1-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (32 kB)
2025-09-27T18:28:00.259545321Z Using cached google_resumable_media-2.7.2-py2.py3-none-any.whl (81 kB)
2025-09-27T18:28:00.260728414Z Using cached greenlet-3.2.4-cp313-cp313-manylinux_2_24_x86_64.manylinux_2_28_x86_64.whl (610 kB)
2025-09-27T18:28:00.2622632Z Using cached h11-0.16.0-py3-none-any.whl (37 kB)
2025-09-27T18:28:00.263381837Z Using cached iniconfig-2.1.0-py3-none-any.whl (6.0 kB)
2025-09-27T18:28:00.264470991Z Using cached limits-5.5.0-py3-none-any.whl (60 kB)
2025-09-27T18:28:00.265594198Z Using cached Deprecated-1.2.18-py2.py3-none-any.whl (10.0 kB)
2025-09-27T18:28:00.266719056Z Using cached wrapt-1.17.3-cp313-cp313-manylinux1_x86_64.manylinux_2_28_x86_64.manylinux_2_5_x86_64.whl (88 kB)
2025-09-27T18:28:00.267881057Z Using cached numpy-2.3.3-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl (16.6 MB)
2025-09-27T18:28:00.280827423Z Using cached packaging-25.0-py3-none-any.whl (66 kB)
2025-09-27T18:28:00.281979703Z Using cached psycopg_binary-3.2.10-cp313-cp313-manylinux2014_x86_64.manylinux_2_17_x86_64.whl (4.4 MB)
2025-09-27T18:28:00.28624346Z Using cached pyasn1-0.6.1-py3-none-any.whl (83 kB)
2025-09-27T18:28:00.287426413Z Using cached pyasn1_modules-0.4.2-py3-none-any.whl (181 kB)
2025-09-27T18:28:00.288707535Z Using cached pygments-2.19.2-py3-none-any.whl (1.2 MB)
2025-09-27T18:28:00.29084633Z Using cached PyJWT-2.10.1-py3-none-any.whl (22 kB)
2025-09-27T18:28:00.291968637Z Using cached cryptography-46.0.1-cp311-abi3-manylinux_2_34_x86_64.whl (4.6 MB)
2025-09-27T18:28:00.298140636Z Using cached cffi-2.0.0-cp313-cp313-manylinux2014_x86_64.manylinux_2_17_x86_64.whl (219 kB)
2025-09-27T18:28:00.300101973Z Using cached python_dateutil-2.9.0.post0-py2.py3-none-any.whl (229 kB)
2025-09-27T18:28:00.301978512Z Using cached pytz-2025.2-py2.py3-none-any.whl (509 kB)
2025-09-27T18:28:00.304790821Z Using cached six-1.17.0-py2.py3-none-any.whl (11 kB)
2025-09-27T18:28:00.306149971Z Using cached sniffio-1.3.1-py3-none-any.whl (10 kB)
2025-09-27T18:28:00.307518091Z Using cached typing_inspection-0.4.1-py3-none-any.whl (14 kB)
2025-09-27T18:28:00.308831967Z Using cached tzdata-2025.2-py2.py3-none-any.whl (347 kB)
2025-09-27T18:28:00.310511717Z Using cached google_api_python_client-2.183.0-py3-none-any.whl (14.2 MB)
2025-09-27T18:28:00.323538981Z Using cached google_auth_httplib2-0.2.0-py2.py3-none-any.whl (9.3 kB)
2025-09-27T18:28:00.324835895Z Using cached httplib2-0.31.0-py3-none-any.whl (91 kB)
2025-09-27T18:28:00.326003106Z Using cached pyparsing-3.2.5-py3-none-any.whl (113 kB)
2025-09-27T18:28:00.327250795Z Using cached uritemplate-4.2.0-py3-none-any.whl (11 kB)
2025-09-27T18:28:00.328602304Z Using cached mako-1.3.10-py3-none-any.whl (78 kB)
2025-09-27T18:28:00.329929861Z Using cached MarkupSafe-3.0.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (23 kB)
2025-09-27T18:28:00.331269109Z Using cached pycparser-2.23-py3-none-any.whl (118 kB)
2025-09-27T18:28:00.616742806Z Installing collected packages: pytz, wrapt, urllib3, uritemplate, tzdata, typing-extensions, tqdm, tenacity, structlog, sniffio, six, rapidfuzz, python-multipart, python-dotenv, pyparsing, pymysql, pyjwt, pygments, pycparser, pyasn1, psycopg2-binary, psycopg-binary, psycopg, protobuf, pluggy, packaging, numpy, msgpack, MarkupSafe, iniconfig, idna, hyperframe, hpack, h11, greenlet, google-crc32c, coverage, click, charset_normalizer, certifi, cachetools, annotated-types, uvicorn, typing-inspection, sqlalchemy, sentry-sdk, rsa, requests, python-dateutil, pytest, pydantic-core, pyasn1-modules, proto-plus, Mako, httplib2, httpcore, h2, grpcio, googleapis-common-protos, google-resumable-media, deprecated, cffi, anyio, starlette, pytest-cov, pytest-asyncio, pydantic, pandas, limits, httpx, grpcio-status, google-auth, cryptography, cachecontrol, alembic, slowapi, google-auth-httplib2, google-api-core, fastapi, google-cloud-core, google-api-python-client, google-cloud-storage, google-cloud-firestore, google-ai-generativelanguage, google-generativeai, firebase-admin
2025-09-27T18:28:23.092540309Z 
2025-09-27T18:28:23.1004899Z Successfully installed Mako-1.3.10 MarkupSafe-3.0.2 alembic-1.16.5 annotated-types-0.7.0 anyio-4.11.0 cachecontrol-0.14.3 cachetools-5.5.2 certifi-2025.8.3 cffi-2.0.0 charset_normalizer-3.4.3 click-8.3.0 coverage-7.10.7 cryptography-46.0.1 deprecated-1.2.18 fastapi-0.117.1 firebase-admin-7.1.0 google-ai-generativelanguage-0.6.15 google-api-core-2.25.1 google-api-python-client-2.183.0 google-auth-2.40.3 google-auth-httplib2-0.2.0 google-cloud-core-2.4.3 google-cloud-firestore-2.21.0 google-cloud-storage-3.4.0 google-crc32c-1.7.1 google-generativeai-0.8.5 google-resumable-media-2.7.2 googleapis-common-protos-1.70.0 greenlet-3.2.4 grpcio-1.75.1 grpcio-status-1.71.2 h11-0.16.0 h2-4.3.0 hpack-4.1.0 httpcore-1.0.9 httplib2-0.31.0 httpx-0.28.1 hyperframe-6.1.0 idna-3.10 iniconfig-2.1.0 limits-5.5.0 msgpack-1.1.1 numpy-2.3.3 packaging-25.0 pandas-2.3.2 pluggy-1.6.0 proto-plus-1.26.1 protobuf-5.29.5 psycopg-3.2.10 psycopg-binary-3.2.10 psycopg2-binary-2.9.10 pyasn1-0.6.1 pyasn1-modules-0.4.2 pycparser-2.23 pydantic-2.11.9 pydantic-core-2.33.2 pygments-2.19.2 pyjwt-2.10.1 pymysql-1.1.2 pyparsing-3.2.5 pytest-8.4.2 pytest-asyncio-1.2.0 pytest-cov-7.0.0 python-dateutil-2.9.0.post0 python-dotenv-1.1.1 python-multipart-0.0.20 pytz-2025.2 rapidfuzz-3.14.1 requests-2.32.5 rsa-4.9.1 sentry-sdk-2.39.0 six-1.17.0 slowapi-0.1.9 sniffio-1.3.1 sqlalchemy-2.0.43 starlette-0.48.0 structlog-25.4.0 tenacity-9.1.2 tqdm-4.67.1 typing-extensions-4.15.0 typing-inspection-0.4.1 tzdata-2025.2 uritemplate-4.2.0 urllib3-2.5.0 uvicorn-0.37.0 wrapt-1.17.3
2025-09-27T18:28:23.107477751Z 
2025-09-27T18:28:23.107492912Z [notice] A new release of pip is available: 25.1.1 -> 25.2
2025-09-27T18:28:23.107496293Z [notice] To update, run: pip install --upgrade pip
2025-09-27T18:28:25.237177855Z ==> Uploading build...
2025-09-27T18:28:44.794348379Z ==> Uploaded in 15.6s. Compression took 3.9s
2025-09-27T18:28:44.879919536Z ==> Build successful ðŸŽ‰
2025-09-27T18:28:47.146747866Z ==> Deploying...
2025-09-27T18:29:21.180026818Z ==> Running '   cd backend && python init_db.py && uvicorn src.main:app --host 0.0.0.0 --port $PORT'
2025-09-27T18:29:30.786571277Z ðŸ”„ Initializing database...
2025-09-27T18:29:30.786593538Z âœ… Database initialized successfully!
2025-09-27T18:29:50.128974602Z /opt/render/project/src/.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:373: UserWarning: Valid config keys have changed in V2:
2025-09-27T18:29:50.128998512Z * 'schema_extra' has been renamed to 'json_schema_extra'
2025-09-27T18:29:50.129003902Z   warnings.warn(message, UserWarning)
2025-09-27T18:29:50.23579466Z INFO:     Started server process [56]
2025-09-27T18:29:50.235817041Z INFO:     Waiting for application startup.
2025-09-27T18:29:50.926674472Z INFO:     Application startup complete.
2025-09-27T18:29:50.927019311Z INFO:     Uvicorn running on http://0.0.0.0:10000 (Press CTRL+C to quit)
2025-09-27T18:29:51.026913757Z No .env file found at: /opt/render/project/src/backend/.env
2025-09-27T18:29:51.026936648Z Make sure to create a .env file with your GEMINI_API_KEY
2025-09-27T18:29:51.026941658Z âœ… Gemini API key loaded successfully
2025-09-27T18:29:51.026947238Z ðŸ“Š Using model: gemini-1.5-pro, temperature: 0.8
2025-09-27T18:29:51.026953098Z ðŸ’° Daily cost limit: $1.0, Monthly: $10.0
2025-09-27T18:29:51.026958438Z âœ… AI Product Descriptions API started successfully
2025-09-27T18:29:51.026963688Z ðŸ¤– Model: gemini-1.5-pro (Live mode)
2025-09-27T18:29:51.026970019Z ðŸŒ¡ï¸  Temperature: 0.8
2025-09-27T18:29:51.026976179Z âœ… API key configured - ready for AI generation
2025-09-27T18:29:51.026981719Z ðŸ’³ Credit service initialized - rate limiting enabled
2025-09-27T18:29:51.026987529Z ðŸ“‹ Subscription plans initialized
2025-09-27T18:29:51.026993159Z INFO:     127.0.0.1:49022 - "HEAD / HTTP/1.1" 404 Not Found
2025-09-27T18:29:57.807123804Z ==> Your service is live ðŸŽ‰
2025-09-27T18:29:57.917374633Z ==> 
2025-09-27T18:29:57.999607733Z ==> ///////////////////////////////////////////////////////////
2025-09-27T18:29:58.114960602Z ==> 
2025-09-27T18:29:58.192307281Z ==> Available at your primary URL https://ai-product-descriptions.onrender.com
2025-09-27T18:29:58.268947731Z ==> 
2025-09-27T18:29:58.34475005Z ==> ///////////////////////////////////////////////////////////
2025-09-27T18:29:59.750940722Z INFO:     34.168.108.203:0 - "GET / HTTP/1.1" 404 Not Found
2025-09-27T18:31:20.675890155Z WARNING:root:Invalid auth header format
2025-09-27T18:31:20.676165962Z INFO:     206.204.18.92:0 - "GET /api/payment/user/credits HTTP/1.1" 401 Unauthorized
2025-09-27T18:31:35.531444976Z WARNING:root:Invalid auth header format
2025-09-27T18:31:35.531881738Z INFO:     104.253.252.247:0 - "GET /api/payment/user/credits HTTP/1.1" 401 Unauthorized
2025-09-27T18:32:41.388669363Z INFO:     143.110.233.37:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 400 Bad Request
2025-09-27T18:32:41.403903064Z INFO:     143.198.65.54:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 400 Bad Request
2025-09-27T18:34:03.439781794Z WARNING:root:Invalid auth header format
2025-09-27T18:34:03.440071452Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 401 Unauthorized
2025-09-27T18:34:03.446209834Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:03.44757657Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:03.44795259Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-27T18:34:03.449380608Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:03.596555258Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-27T18:34:03.598798097Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:04.13327902Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-27T18:34:04.134198614Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 500 Internal Server Error
2025-09-27T18:34:04.228300835Z ERROR:    Exception in ASGI application
2025-09-27T18:34:04.228337076Z   + Exception Group Traceback (most recent call last):
2025-09-27T18:34:04.228340326Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
2025-09-27T18:34:04.228342576Z   |     yield
2025-09-27T18:34:04.228344806Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 183, in __call__
2025-09-27T18:34:04.228346846Z   |     async with anyio.create_task_group() as task_group:
2025-09-27T18:34:04.228348926Z   |                ~~~~~~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:04.228351137Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 781, in __aexit__
2025-09-27T18:34:04.228353226Z   |     raise BaseExceptionGroup(
2025-09-27T18:34:04.228355567Z   |         "unhandled errors in a TaskGroup", self._exceptions
2025-09-27T18:34:04.228357857Z   |     ) from None
2025-09-27T18:34:04.228360537Z   | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
2025-09-27T18:34:04.228362727Z   +-+---------------- 1 ----------------
2025-09-27T18:34:04.228364727Z     | Traceback (most recent call last):
2025-09-27T18:34:04.228367407Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
2025-09-27T18:34:04.228369567Z     |     result = await app(  # type: ignore[func-returns-value]
2025-09-27T18:34:04.228371647Z     |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228373677Z     |         self.scope, self.receive, self.send
2025-09-27T18:34:04.228375747Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228377817Z     |     )
2025-09-27T18:34:04.228380247Z     |     ^
2025-09-27T18:34:04.228383607Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
2025-09-27T18:34:04.228387178Z     |     return await self.app(scope, receive, send)
2025-09-27T18:34:04.228390478Z     |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228393918Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1082, in __call__
2025-09-27T18:34:04.228397168Z     |     await super().__call__(scope, receive, send)
2025-09-27T18:34:04.228400258Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
2025-09-27T18:34:04.228403858Z     |     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:04.228407198Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
2025-09-27T18:34:04.228410418Z     |     raise exc
2025-09-27T18:34:04.228414118Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
2025-09-27T18:34:04.228418448Z     |     await self.app(scope, receive, _send)
2025-09-27T18:34:04.228422248Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
2025-09-27T18:34:04.228425388Z     |     with recv_stream, send_stream, collapse_excgroups():
2025-09-27T18:34:04.228428388Z     |                                    ~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:04.228432309Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 162, in __exit__
2025-09-27T18:34:04.228436519Z     |     self.gen.throw(value)
2025-09-27T18:34:04.228439409Z     |     ~~~~~~~~~~~~~~^^^^^^^
2025-09-27T18:34:04.228442609Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
2025-09-27T18:34:04.228452439Z     |     raise exc
2025-09-27T18:34:04.228454769Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
2025-09-27T18:34:04.228456859Z     |     response = await self.dispatch_func(request, call_next)
2025-09-27T18:34:04.228458869Z     |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228461519Z     |   File "/opt/render/project/src/backend/src/main.py", line 90, in add_security_headers
2025-09-27T18:34:04.228463569Z     |     response = await call_next(request)
2025-09-27T18:34:04.22846564Z     |                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228467769Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
2025-09-27T18:34:04.2284699Z     |     raise app_exc
2025-09-27T18:34:04.2284721Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
2025-09-27T18:34:04.22847581Z     |     await self.app(scope, receive_or_disconnect, send_no_error)
2025-09-27T18:34:04.22847952Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
2025-09-27T18:34:04.22848314Z     |     await self.simple_response(scope, receive, send, request_headers=headers)
2025-09-27T18:34:04.22848658Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
2025-09-27T18:34:04.22849022Z     |     await self.app(scope, receive, send)
2025-09-27T18:34:04.22849363Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
2025-09-27T18:34:04.228509701Z     |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-09-27T18:34:04.228513331Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:04.228516241Z     |     raise exc
2025-09-27T18:34:04.228519211Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:04.228522411Z     |     await app(scope, receive, sender)
2025-09-27T18:34:04.228525741Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
2025-09-27T18:34:04.228529481Z     |     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:04.228532591Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
2025-09-27T18:34:04.228534711Z     |     await route.handle(scope, receive, send)
2025-09-27T18:34:04.228536901Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
2025-09-27T18:34:04.228539011Z     |     await self.app(scope, receive, send)
2025-09-27T18:34:04.228541091Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
2025-09-27T18:34:04.228543222Z     |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-09-27T18:34:04.228545262Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:04.228547292Z     |     raise exc
2025-09-27T18:34:04.228549402Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:04.228557122Z     |     await app(scope, receive, sender)
2025-09-27T18:34:04.228559282Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
2025-09-27T18:34:04.228561322Z     |     response = await f(request)
2025-09-27T18:34:04.228563412Z     |                ^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228565492Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 297, in app
2025-09-27T18:34:04.228568392Z     |     async with AsyncExitStack() as async_exit_stack:
2025-09-27T18:34:04.228571982Z     |                ~~~~~~~~~~~~~~^^
2025-09-27T18:34:04.228575763Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 768, in __aexit__
2025-09-27T18:34:04.228578972Z     |     raise exc
2025-09-27T18:34:04.228582343Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 751, in __aexit__
2025-09-27T18:34:04.228585833Z     |     cb_suppress = await cb(*exc_details)
2025-09-27T18:34:04.228589203Z     |                   ^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228592683Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 221, in __aexit__
2025-09-27T18:34:04.228596133Z     |     await anext(self.gen)
2025-09-27T18:34:04.228599863Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/concurrency.py", line 37, in contextmanager_in_threadpool
2025-09-27T18:34:04.228602803Z     |     await anyio.to_thread.run_sync(
2025-09-27T18:34:04.228604903Z     |         cm.__exit__, None, None, None, limiter=exit_limiter
2025-09-27T18:34:04.228607103Z     |     )
2025-09-27T18:34:04.228609153Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/to_thread.py", line 56, in run_sync
2025-09-27T18:34:04.228611243Z     |     return await get_async_backend().run_sync_in_worker_thread(
2025-09-27T18:34:04.228613304Z     |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228615324Z     |         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
2025-09-27T18:34:04.228617364Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228619473Z     |     )
2025-09-27T18:34:04.228621534Z     |     ^
2025-09-27T18:34:04.228623654Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2485, in run_sync_in_worker_thread
2025-09-27T18:34:04.228625754Z     |     return await future
2025-09-27T18:34:04.228627814Z     |            ^^^^^^^^^^^^
2025-09-27T18:34:04.228629914Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 976, in run
2025-09-27T18:34:04.228632004Z     |     result = context.run(func, *args)
2025-09-27T18:34:04.228634114Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 148, in __exit__
2025-09-27T18:34:04.228636204Z     |     next(self.gen)
2025-09-27T18:34:04.228638264Z     |     ~~~~^^^^^^^^^^
2025-09-27T18:34:04.228640384Z     |   File "/opt/render/project/src/backend/src/database/deps.py", line 73, in get_db
2025-09-27T18:34:04.228642484Z     |     db.close()
2025-09-27T18:34:04.228644534Z     |     ~~~~~~~~^^
2025-09-27T18:34:04.228646634Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2521, in close
2025-09-27T18:34:04.228648684Z     |     self._close_impl(invalidate=False)
2025-09-27T18:34:04.228650764Z     |     ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228652854Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2590, in _close_impl
2025-09-27T18:34:04.228660345Z     |     transaction.close(invalidate)
2025-09-27T18:34:04.228663865Z     |     ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
2025-09-27T18:34:04.228677605Z     |   File "<string>", line 2, in close
2025-09-27T18:34:04.228681175Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 119, in _go
2025-09-27T18:34:04.228684805Z     |     raise sa_exc.IllegalStateChangeError(
2025-09-27T18:34:04.228725896Z     |     ...<5 lines>...
2025-09-27T18:34:04.228728547Z     |     )
2025-09-27T18:34:04.228732996Z     | sqlalchemy.exc.IllegalStateChangeError: Method 'close()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-27T18:34:04.228735367Z     +------------------------------------
2025-09-27T18:34:04.228738097Z 
2025-09-27T18:34:04.228740297Z During handling of the above exception, another exception occurred:
2025-09-27T18:34:04.228742257Z 
2025-09-27T18:34:04.228744317Z Traceback (most recent call last):
2025-09-27T18:34:04.228746067Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
2025-09-27T18:34:04.228747727Z     result = await app(  # type: ignore[func-returns-value]
2025-09-27T18:34:04.228749417Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228752227Z         self.scope, self.receive, self.send
2025-09-27T18:34:04.228755117Z         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228757857Z     )
2025-09-27T18:34:04.228760577Z     ^
2025-09-27T18:34:04.228763447Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
2025-09-27T18:34:04.228766128Z     return await self.app(scope, receive, send)
2025-09-27T18:34:04.228768788Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228771708Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1082, in __call__
2025-09-27T18:34:04.228774548Z     await super().__call__(scope, receive, send)
2025-09-27T18:34:04.228777328Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
2025-09-27T18:34:04.228779008Z     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:04.228781598Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
2025-09-27T18:34:04.228784458Z     raise exc
2025-09-27T18:34:04.228787218Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
2025-09-27T18:34:04.228789898Z     await self.app(scope, receive, _send)
2025-09-27T18:34:04.228792688Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
2025-09-27T18:34:04.228795198Z     with recv_stream, send_stream, collapse_excgroups():
2025-09-27T18:34:04.228798068Z                                    ~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:04.228800758Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 162, in __exit__
2025-09-27T18:34:04.228803349Z     self.gen.throw(value)
2025-09-27T18:34:04.228805758Z     ~~~~~~~~~~~~~~^^^^^^^
2025-09-27T18:34:04.228808578Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
2025-09-27T18:34:04.228816739Z     raise exc
2025-09-27T18:34:04.228819549Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
2025-09-27T18:34:04.228822629Z     response = await self.dispatch_func(request, call_next)
2025-09-27T18:34:04.228825669Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228827739Z   File "/opt/render/project/src/backend/src/main.py", line 90, in add_security_headers
2025-09-27T18:34:04.228829539Z     response = await call_next(request)
2025-09-27T18:34:04.228831189Z                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228832929Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
2025-09-27T18:34:04.228834809Z     raise app_exc
2025-09-27T18:34:04.228836489Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
2025-09-27T18:34:04.228838819Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:04.228838889Z     await self.app(scope, receive_or_disconnect, send_no_error)
2025-09-27T18:34:04.22884275Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
2025-09-27T18:34:04.22884615Z     await self.simple_response(scope, receive, send, request_headers=headers)
2025-09-27T18:34:04.22884915Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
2025-09-27T18:34:04.228852Z     await self.app(scope, receive, send)
2025-09-27T18:34:04.22885481Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
2025-09-27T18:34:04.22886767Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-09-27T18:34:04.22887135Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:04.22887387Z     raise exc
2025-09-27T18:34:04.22887607Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:04.22887845Z     await app(scope, receive, sender)
2025-09-27T18:34:04.228901521Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
2025-09-27T18:34:04.228905381Z     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:04.228908181Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
2025-09-27T18:34:04.228910811Z     await route.handle(scope, receive, send)
2025-09-27T18:34:04.228913081Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
2025-09-27T18:34:04.228915151Z     await self.app(scope, receive, send)
2025-09-27T18:34:04.228917192Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
2025-09-27T18:34:04.228919592Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-09-27T18:34:04.228921761Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:04.228923822Z     raise exc
2025-09-27T18:34:04.228926092Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:04.228928192Z     await app(scope, receive, sender)
2025-09-27T18:34:04.228930262Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
2025-09-27T18:34:04.228941922Z     response = await f(request)
2025-09-27T18:34:04.228944332Z                ^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228946492Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 297, in app
2025-09-27T18:34:04.228948632Z     async with AsyncExitStack() as async_exit_stack:
2025-09-27T18:34:04.228950772Z                ~~~~~~~~~~~~~~^^
2025-09-27T18:34:04.228953022Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 768, in __aexit__
2025-09-27T18:34:04.228955062Z     raise exc
2025-09-27T18:34:04.228957102Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 751, in __aexit__
2025-09-27T18:34:04.228959573Z     cb_suppress = await cb(*exc_details)
2025-09-27T18:34:04.228961753Z                   ^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228964253Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 221, in __aexit__
2025-09-27T18:34:04.228966593Z     await anext(self.gen)
2025-09-27T18:34:04.228969903Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/concurrency.py", line 37, in contextmanager_in_threadpool
2025-09-27T18:34:04.228972463Z     await anyio.to_thread.run_sync(
2025-09-27T18:34:04.228974663Z         cm.__exit__, None, None, None, limiter=exit_limiter
2025-09-27T18:34:04.228976853Z     )
2025-09-27T18:34:04.228979143Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/to_thread.py", line 56, in run_sync
2025-09-27T18:34:04.228981713Z     return await get_async_backend().run_sync_in_worker_thread(
2025-09-27T18:34:04.228984123Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228986823Z         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
2025-09-27T18:34:04.228989373Z         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.228992023Z     )
2025-09-27T18:34:04.228994514Z     ^
2025-09-27T18:34:04.228996703Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2485, in run_sync_in_worker_thread
2025-09-27T18:34:04.228998914Z     return await future
2025-09-27T18:34:04.229001224Z            ^^^^^^^^^^^^
2025-09-27T18:34:04.229003434Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 976, in run
2025-09-27T18:34:04.229005584Z     result = context.run(func, *args)
2025-09-27T18:34:04.229007794Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 148, in __exit__
2025-09-27T18:34:04.229009914Z     next(self.gen)
2025-09-27T18:34:04.229011904Z     ~~~~^^^^^^^^^^
2025-09-27T18:34:04.229014524Z   File "/opt/render/project/src/backend/src/database/deps.py", line 73, in get_db
2025-09-27T18:34:04.229016654Z     db.close()
2025-09-27T18:34:04.229018624Z     ~~~~~~~~^^
2025-09-27T18:34:04.229020644Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2521, in close
2025-09-27T18:34:04.229022684Z     self._close_impl(invalidate=False)
2025-09-27T18:34:04.229024734Z     ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:04.229026794Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2590, in _close_impl
2025-09-27T18:34:04.229028744Z     transaction.close(invalidate)
2025-09-27T18:34:04.229030735Z     ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
2025-09-27T18:34:04.229032675Z   File "<string>", line 2, in close
2025-09-27T18:34:04.229034724Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 119, in _go
2025-09-27T18:34:04.229041095Z     raise sa_exc.IllegalStateChangeError(
2025-09-27T18:34:04.229043485Z     ...<5 lines>...
2025-09-27T18:34:04.229045495Z     )
2025-09-27T18:34:04.229049325Z sqlalchemy.exc.IllegalStateChangeError: Method 'close()' can't be called here; method 'commit()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
2025-09-27T18:34:04.333036567Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-27T18:34:04.335650355Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-27T18:34:04.401256095Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:04.592758754Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:04.802472404Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-27T18:34:21.489717034Z INFO:     41.238.10.39:0 - "OPTIONS /api/generate-batch HTTP/1.1" 200 OK
2025-09-27T18:34:21.731747366Z WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
2025-09-27T18:34:21.731771256Z E0000 00:00:1758998061.731597      56 alts_credentials.cc:93] ALTS creds ignored. Not running on GCP and untrusted ALTS is not enabled.
2025-09-27T18:34:25.037926042Z ERROR:root:Generation error for product row_0: Gemini API Error (RETRY_EXHAUSTED): All retry attempts exhausted: RetryError[<Future at 0x7f48b87b7c50 state=finished raised NotFound>]
2025-09-27T18:34:25.037965163Z ERROR:root:Error type: Exception
2025-09-27T18:34:25.037984244Z WARNING:root:All retry attempts exhausted for product: AeroFlex Ergonomic Office Chair
2025-09-27T18:34:25.0499765Z ERROR:src.payments.sqlalchemy_service:Failed to log usage: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065"
2025-09-27T18:34:25.049989071Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:25.0499935Z                                                              ^
2025-09-27T18:34:25.049997151Z 
2025-09-27T18:34:25.050002341Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:25.050009241Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183425Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:25.050012871Z (Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-09-27T18:34:25.05037275Z ERROR:src.payments.credit_service:Error deducting credits for user bpR6MB3823T20EK7BEa3cs2y22u2: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065"
2025-09-27T18:34:25.050403431Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:25.050408291Z                                                              ^
2025-09-27T18:34:25.050411562Z 
2025-09-27T18:34:25.050415432Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:25.050419172Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183425Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:25.050422972Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:25.050439712Z WARNING:root:Failed to deduct credits for user bpR6MB3823T20EK7BEa3cs2y22u2: Failed to deduct credits: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065"
2025-09-27T18:34:25.050445992Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:25.050448672Z                                                              ^
2025-09-27T18:34:25.050451193Z 
2025-09-27T18:34:25.050453583Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:25.050456093Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183425Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:25.050458443Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:25.051438039Z ERROR:src.database.deps:Database session error, rolling back: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065"
2025-09-27T18:34:25.051448329Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:25.051462189Z                                                              ^
2025-09-27T18:34:25.051464949Z 
2025-09-27T18:34:25.05146975Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:25.05147439Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183425Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:25.05147784Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:25.051986953Z INFO:     41.238.10.39:0 - "POST /api/generate-batch HTTP/1.1" 500 Internal Server Error
2025-09-27T18:34:25.123288253Z ERROR:    Exception in ASGI application
2025-09-27T18:34:25.123304463Z   + Exception Group Traceback (most recent call last):
2025-09-27T18:34:25.123307904Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
2025-09-27T18:34:25.123310593Z   |     yield
2025-09-27T18:34:25.123312874Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 183, in __call__
2025-09-27T18:34:25.123315114Z   |     async with anyio.create_task_group() as task_group:
2025-09-27T18:34:25.123317204Z   |                ~~~~~~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:25.123319284Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 781, in __aexit__
2025-09-27T18:34:25.123321334Z   |     raise BaseExceptionGroup(
2025-09-27T18:34:25.123323454Z   |         "unhandled errors in a TaskGroup", self._exceptions
2025-09-27T18:34:25.123326774Z   |     ) from None
2025-09-27T18:34:25.123329554Z   | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
2025-09-27T18:34:25.123331634Z   +-+---------------- 1 ----------------
2025-09-27T18:34:25.123333644Z     | Traceback (most recent call last):
2025-09-27T18:34:25.123336924Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
2025-09-27T18:34:25.123339034Z     |     result = await app(  # type: ignore[func-returns-value]
2025-09-27T18:34:25.123341154Z     |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123343184Z     |         self.scope, self.receive, self.send
2025-09-27T18:34:25.123345254Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123347374Z     |     )
2025-09-27T18:34:25.123349434Z     |     ^
2025-09-27T18:34:25.123352525Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
2025-09-27T18:34:25.123356335Z     |     return await self.app(scope, receive, send)
2025-09-27T18:34:25.123359965Z     |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123363395Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1082, in __call__
2025-09-27T18:34:25.123381435Z     |     await super().__call__(scope, receive, send)
2025-09-27T18:34:25.123385855Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
2025-09-27T18:34:25.123388546Z     |     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:25.123390856Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
2025-09-27T18:34:25.123392956Z     |     raise exc
2025-09-27T18:34:25.123395126Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
2025-09-27T18:34:25.123397186Z     |     await self.app(scope, receive, _send)
2025-09-27T18:34:25.123399226Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
2025-09-27T18:34:25.123401296Z     |     with recv_stream, send_stream, collapse_excgroups():
2025-09-27T18:34:25.123403346Z     |                                    ~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:25.123407116Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 162, in __exit__
2025-09-27T18:34:25.123409676Z     |     self.gen.throw(value)
2025-09-27T18:34:25.123411686Z     |     ~~~~~~~~~~~~~~^^^^^^^
2025-09-27T18:34:25.123413676Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
2025-09-27T18:34:25.123415776Z     |     raise exc
2025-09-27T18:34:25.123417876Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
2025-09-27T18:34:25.123420196Z     |     response = await self.dispatch_func(request, call_next)
2025-09-27T18:34:25.123422267Z     |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123424816Z     |   File "/opt/render/project/src/backend/src/main.py", line 90, in add_security_headers
2025-09-27T18:34:25.123426876Z     |     response = await call_next(request)
2025-09-27T18:34:25.123428967Z     |                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123431017Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
2025-09-27T18:34:25.123433067Z     |     raise app_exc
2025-09-27T18:34:25.123435877Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
2025-09-27T18:34:25.123437897Z     |     await self.app(scope, receive_or_disconnect, send_no_error)
2025-09-27T18:34:25.123439767Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
2025-09-27T18:34:25.123441487Z     |     await self.simple_response(scope, receive, send, request_headers=headers)
2025-09-27T18:34:25.123443137Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
2025-09-27T18:34:25.123445557Z     |     await self.app(scope, receive, send)
2025-09-27T18:34:25.123448217Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
2025-09-27T18:34:25.123459548Z     |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-09-27T18:34:25.123462748Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:25.123465438Z     |     raise exc
2025-09-27T18:34:25.123468578Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:25.123475738Z     |     await app(scope, receive, sender)
2025-09-27T18:34:25.123477488Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
2025-09-27T18:34:25.123479208Z     |     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:25.123480898Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
2025-09-27T18:34:25.123482538Z     |     await route.handle(scope, receive, send)
2025-09-27T18:34:25.123484158Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
2025-09-27T18:34:25.123485788Z     |     await self.app(scope, receive, send)
2025-09-27T18:34:25.123487488Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
2025-09-27T18:34:25.123489308Z     |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-09-27T18:34:25.123490968Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:25.123492588Z     |     raise exc
2025-09-27T18:34:25.123494318Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:25.123495958Z     |     await app(scope, receive, sender)
2025-09-27T18:34:25.123497589Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
2025-09-27T18:34:25.123499278Z     |     response = await f(request)
2025-09-27T18:34:25.123500938Z     |                ^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123502569Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 297, in app
2025-09-27T18:34:25.123504239Z     |     async with AsyncExitStack() as async_exit_stack:
2025-09-27T18:34:25.123505899Z     |                ~~~~~~~~~~~~~~^^
2025-09-27T18:34:25.123507539Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 768, in __aexit__
2025-09-27T18:34:25.123509169Z     |     raise exc
2025-09-27T18:34:25.123510799Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 751, in __aexit__
2025-09-27T18:34:25.123512449Z     |     cb_suppress = await cb(*exc_details)
2025-09-27T18:34:25.123514169Z     |                   ^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123515819Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 221, in __aexit__
2025-09-27T18:34:25.123517469Z     |     await anext(self.gen)
2025-09-27T18:34:25.123519299Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/concurrency.py", line 37, in contextmanager_in_threadpool
2025-09-27T18:34:25.123520999Z     |     await anyio.to_thread.run_sync(
2025-09-27T18:34:25.123523069Z     |         cm.__exit__, None, None, None, limiter=exit_limiter
2025-09-27T18:34:25.123524709Z     |     )
2025-09-27T18:34:25.123526329Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/to_thread.py", line 56, in run_sync
2025-09-27T18:34:25.123528109Z     |     return await get_async_backend().run_sync_in_worker_thread(
2025-09-27T18:34:25.123529749Z     |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123531749Z     |         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
2025-09-27T18:34:25.12353471Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.12354204Z     |     )
2025-09-27T18:34:25.12354494Z     |     ^
2025-09-27T18:34:25.1235476Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2485, in run_sync_in_worker_thread
2025-09-27T18:34:25.12355041Z     |     return await future
2025-09-27T18:34:25.12355295Z     |            ^^^^^^^^^^^^
2025-09-27T18:34:25.12355566Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 976, in run
2025-09-27T18:34:25.12355843Z     |     result = context.run(func, *args)
2025-09-27T18:34:25.12356013Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 148, in __exit__
2025-09-27T18:34:25.1235618Z     |     next(self.gen)
2025-09-27T18:34:25.12356345Z     |     ~~~~^^^^^^^^^^
2025-09-27T18:34:25.12356507Z     |   File "/opt/render/project/src/backend/src/database/deps.py", line 66, in get_db
2025-09-27T18:34:25.12356669Z     |     db.commit()
2025-09-27T18:34:25.12356833Z     |     ~~~~~~~~~^^
2025-09-27T18:34:25.12356996Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
2025-09-27T18:34:25.12357164Z     |     trans.commit(_to_root=True)
2025-09-27T18:34:25.123573271Z     |     ~~~~~~~~~~~~^^^^^^^^^^^^^^^
2025-09-27T18:34:25.12357496Z     |   File "<string>", line 2, in commit
2025-09-27T18:34:25.1235766Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
2025-09-27T18:34:25.12357832Z     |     self._raise_for_prerequisite_state(fn.__name__, current_state)
2025-09-27T18:34:25.123586351Z     |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123588271Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
2025-09-27T18:34:25.123589971Z     |     raise sa_exc.PendingRollbackError(
2025-09-27T18:34:25.123591661Z     |     ...<6 lines>...
2025-09-27T18:34:25.123593331Z     |     )
2025-09-27T18:34:25.123596721Z     | sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065"
2025-09-27T18:34:25.123598621Z     | LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:25.123600321Z     |                                                              ^
2025-09-27T18:34:25.123602031Z     | 
2025-09-27T18:34:25.123604261Z     | [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:25.123606401Z     | [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183425Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:25.123611892Z     | (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:25.123613672Z     +------------------------------------
2025-09-27T18:34:25.123615212Z 
2025-09-27T18:34:25.123616901Z During handling of the above exception, another exception occurred:
2025-09-27T18:34:25.123618892Z 
2025-09-27T18:34:25.123621762Z Traceback (most recent call last):
2025-09-27T18:34:25.123624482Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
2025-09-27T18:34:25.123627222Z     result = await app(  # type: ignore[func-returns-value]
2025-09-27T18:34:25.123630142Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123632792Z         self.scope, self.receive, self.send
2025-09-27T18:34:25.123635342Z         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123638132Z     )
2025-09-27T18:34:25.123640942Z     ^
2025-09-27T18:34:25.123643802Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
2025-09-27T18:34:25.123645512Z     return await self.app(scope, receive, send)
2025-09-27T18:34:25.123647122Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123648793Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1082, in __call__
2025-09-27T18:34:25.123650413Z     await super().__call__(scope, receive, send)
2025-09-27T18:34:25.123652082Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
2025-09-27T18:34:25.123653702Z     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:25.123655342Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
2025-09-27T18:34:25.123657053Z     raise exc
2025-09-27T18:34:25.123658733Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
2025-09-27T18:34:25.123660383Z     await self.app(scope, receive, _send)
2025-09-27T18:34:25.123662003Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
2025-09-27T18:34:25.123663643Z     with recv_stream, send_stream, collapse_excgroups():
2025-09-27T18:34:25.123665243Z                                    ~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:25.123666963Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 162, in __exit__
2025-09-27T18:34:25.123668633Z     self.gen.throw(value)
2025-09-27T18:34:25.123670303Z     ~~~~~~~~~~~~~~^^^^^^^
2025-09-27T18:34:25.123672013Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
2025-09-27T18:34:25.123673673Z     raise exc
2025-09-27T18:34:25.123675373Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
2025-09-27T18:34:25.123677023Z     response = await self.dispatch_func(request, call_next)
2025-09-27T18:34:25.123678663Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123685643Z   File "/opt/render/project/src/backend/src/main.py", line 90, in add_security_headers
2025-09-27T18:34:25.123707274Z     response = await call_next(request)
2025-09-27T18:34:25.123709954Z                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123713024Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
2025-09-27T18:34:25.123719914Z     raise app_exc
2025-09-27T18:34:25.123721724Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
2025-09-27T18:34:25.123723464Z     await self.app(scope, receive_or_disconnect, send_no_error)
2025-09-27T18:34:25.123725175Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
2025-09-27T18:34:25.123726864Z     await self.simple_response(scope, receive, send, request_headers=headers)
2025-09-27T18:34:25.123728604Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
2025-09-27T18:34:25.123730244Z     await self.app(scope, receive, send)
2025-09-27T18:34:25.123731945Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
2025-09-27T18:34:25.123733995Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-09-27T18:34:25.123735605Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:25.123737235Z     raise exc
2025-09-27T18:34:25.123738855Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:25.123740535Z     await app(scope, receive, sender)
2025-09-27T18:34:25.123742285Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
2025-09-27T18:34:25.123743915Z     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:25.123745575Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
2025-09-27T18:34:25.123747265Z     await route.handle(scope, receive, send)
2025-09-27T18:34:25.123748895Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
2025-09-27T18:34:25.123750585Z     await self.app(scope, receive, send)
2025-09-27T18:34:25.123752205Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
2025-09-27T18:34:25.123753835Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-09-27T18:34:25.123755485Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:25.123757105Z     raise exc
2025-09-27T18:34:25.123758735Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:25.123760375Z     await app(scope, receive, sender)
2025-09-27T18:34:25.123762025Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
2025-09-27T18:34:25.123763656Z     response = await f(request)
2025-09-27T18:34:25.123765325Z                ^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123766965Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 297, in app
2025-09-27T18:34:25.123768685Z     async with AsyncExitStack() as async_exit_stack:
2025-09-27T18:34:25.123770356Z                ~~~~~~~~~~~~~~^^
2025-09-27T18:34:25.123771996Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 768, in __aexit__
2025-09-27T18:34:25.123773666Z     raise exc
2025-09-27T18:34:25.123775296Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 751, in __aexit__
2025-09-27T18:34:25.123777996Z     cb_suppress = await cb(*exc_details)
2025-09-27T18:34:25.123780986Z                   ^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123788036Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 221, in __aexit__
2025-09-27T18:34:25.123790946Z     await anext(self.gen)
2025-09-27T18:34:25.123793866Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/concurrency.py", line 37, in contextmanager_in_threadpool
2025-09-27T18:34:25.123796506Z     await anyio.to_thread.run_sync(
2025-09-27T18:34:25.123799386Z         cm.__exit__, None, None, None, limiter=exit_limiter
2025-09-27T18:34:25.123802146Z     )
2025-09-27T18:34:25.123804177Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/to_thread.py", line 56, in run_sync
2025-09-27T18:34:25.123805846Z     return await get_async_backend().run_sync_in_worker_thread(
2025-09-27T18:34:25.123807486Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123809247Z         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
2025-09-27T18:34:25.123810967Z         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123812607Z     )
2025-09-27T18:34:25.123814257Z     ^
2025-09-27T18:34:25.123816027Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2485, in run_sync_in_worker_thread
2025-09-27T18:34:25.123817667Z     return await future
2025-09-27T18:34:25.123819317Z            ^^^^^^^^^^^^
2025-09-27T18:34:25.123821027Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 976, in run
2025-09-27T18:34:25.123822677Z     result = context.run(func, *args)
2025-09-27T18:34:25.123833437Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 148, in __exit__
2025-09-27T18:34:25.123835307Z     next(self.gen)
2025-09-27T18:34:25.123836947Z     ~~~~^^^^^^^^^^
2025-09-27T18:34:25.123838627Z   File "/opt/render/project/src/backend/src/database/deps.py", line 66, in get_db
2025-09-27T18:34:25.123840247Z     db.commit()
2025-09-27T18:34:25.123841878Z     ~~~~~~~~~^^
2025-09-27T18:34:25.123843618Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
2025-09-27T18:34:25.123845258Z     trans.commit(_to_root=True)
2025-09-27T18:34:25.123846958Z     ~~~~~~~~~~~~^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123848618Z   File "<string>", line 2, in commit
2025-09-27T18:34:25.123850318Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
2025-09-27T18:34:25.123852058Z     self._raise_for_prerequisite_state(fn.__name__, current_state)
2025-09-27T18:34:25.123853778Z     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:25.123855468Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
2025-09-27T18:34:25.123857138Z     raise sa_exc.PendingRollbackError(
2025-09-27T18:34:25.123858768Z     ...<6 lines>...
2025-09-27T18:34:25.123860428Z     )
2025-09-27T18:34:25.123862558Z sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065"
2025-09-27T18:34:25.123865368Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:25.123868248Z                                                              ^
2025-09-27T18:34:25.123875718Z 
2025-09-27T18:34:25.123880548Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:25.123883789Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998065', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183425Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:25.123886679Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:56.037491812Z ==> Detected service running on port 10000
2025-09-27T18:34:56.299233845Z ==> Docs on specifying a port: https://render.com/docs/web-services#port-binding
2025-09-27T18:34:52.461737679Z ERROR:root:Generation error for product row_0: Gemini API Error (RETRY_EXHAUSTED): All retry attempts exhausted: RetryError[<Future at 0x7f48b82fe9f0 state=finished raised NotFound>]
2025-09-27T18:34:52.461760749Z ERROR:root:Error type: Exception
2025-09-27T18:34:52.461833091Z WARNING:root:All retry attempts exhausted for product: AeroFlex Ergonomic Office Chair
2025-09-27T18:34:52.479824485Z ERROR:src.payments.sqlalchemy_service:Failed to log usage: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092"
2025-09-27T18:34:52.479844616Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:52.479849666Z                                                              ^
2025-09-27T18:34:52.479853506Z 
2025-09-27T18:34:52.479859246Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:52.479864777Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183452Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:52.479868877Z (Background on this error at: https://sqlalche.me/e/20/9h9h)
2025-09-27T18:34:52.479874337Z ERROR:src.payments.credit_service:Error deducting credits for user bpR6MB3823T20EK7BEa3cs2y22u2: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092"
2025-09-27T18:34:52.479879467Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:52.479884117Z                                                              ^
2025-09-27T18:34:52.479888117Z 
2025-09-27T18:34:52.479889677Z INFO:     41.238.10.39:0 - "POST /api/generate-batch HTTP/1.1" 500 Internal Server Error
2025-09-27T18:34:52.479905358Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:52.479908568Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183452Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:52.479912328Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:52.479914958Z WARNING:root:Failed to deduct credits for user bpR6MB3823T20EK7BEa3cs2y22u2: Failed to deduct credits: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092"
2025-09-27T18:34:52.479917568Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:52.479920318Z                                                              ^
2025-09-27T18:34:52.479922568Z 
2025-09-27T18:34:52.479932248Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:52.479935688Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183452Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:52.479938279Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:52.479942168Z ERROR:src.database.deps:Database session error, rolling back: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092"
2025-09-27T18:34:52.479944759Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:52.479947589Z                                                              ^
2025-09-27T18:34:52.479950329Z 
2025-09-27T18:34:52.479953379Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:52.479961449Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183452Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:52.479964269Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:52.522903431Z ERROR:    Exception in ASGI application
2025-09-27T18:34:52.522922012Z   + Exception Group Traceback (most recent call last):
2025-09-27T18:34:52.522925942Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
2025-09-27T18:34:52.522928562Z   |     yield
2025-09-27T18:34:52.522931162Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 183, in __call__
2025-09-27T18:34:52.522933482Z   |     async with anyio.create_task_group() as task_group:
2025-09-27T18:34:52.522936162Z   |                ~~~~~~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:52.522938842Z   |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 781, in __aexit__
2025-09-27T18:34:52.522941362Z   |     raise BaseExceptionGroup(
2025-09-27T18:34:52.522943932Z   |         "unhandled errors in a TaskGroup", self._exceptions
2025-09-27T18:34:52.522947452Z   |     ) from None
2025-09-27T18:34:52.522951242Z   | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
2025-09-27T18:34:52.522953853Z   +-+---------------- 1 ----------------
2025-09-27T18:34:52.522956242Z     | Traceback (most recent call last):
2025-09-27T18:34:52.522959193Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
2025-09-27T18:34:52.522961733Z     |     result = await app(  # type: ignore[func-returns-value]
2025-09-27T18:34:52.522964193Z     |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.522966593Z     |         self.scope, self.receive, self.send
2025-09-27T18:34:52.522969413Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.522972073Z     |     )
2025-09-27T18:34:52.522975013Z     |     ^
2025-09-27T18:34:52.522977773Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
2025-09-27T18:34:52.522980473Z     |     return await self.app(scope, receive, send)
2025-09-27T18:34:52.522982913Z     |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.522985353Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1082, in __call__
2025-09-27T18:34:52.522987823Z     |     await super().__call__(scope, receive, send)
2025-09-27T18:34:52.522990093Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
2025-09-27T18:34:52.522992774Z     |     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:52.523007444Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
2025-09-27T18:34:52.523010184Z     |     raise exc
2025-09-27T18:34:52.523012814Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
2025-09-27T18:34:52.523015274Z     |     await self.app(scope, receive, _send)
2025-09-27T18:34:52.523017784Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
2025-09-27T18:34:52.523020244Z     |     with recv_stream, send_stream, collapse_excgroups():
2025-09-27T18:34:52.523022524Z     |                                    ~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:52.523026144Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 162, in __exit__
2025-09-27T18:34:52.523029324Z     |     self.gen.throw(value)
2025-09-27T18:34:52.523031895Z     |     ~~~~~~~~~~~~~~^^^^^^^
2025-09-27T18:34:52.523034315Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
2025-09-27T18:34:52.523036735Z     |     raise exc
2025-09-27T18:34:52.523039345Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
2025-09-27T18:34:52.523042115Z     |     response = await self.dispatch_func(request, call_next)
2025-09-27T18:34:52.523044675Z     |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523047985Z     |   File "/opt/render/project/src/backend/src/main.py", line 90, in add_security_headers
2025-09-27T18:34:52.523050455Z     |     response = await call_next(request)
2025-09-27T18:34:52.523052925Z     |                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523055295Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
2025-09-27T18:34:52.523057725Z     |     raise app_exc
2025-09-27T18:34:52.523060215Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
2025-09-27T18:34:52.523062555Z     |     await self.app(scope, receive_or_disconnect, send_no_error)
2025-09-27T18:34:52.523065165Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
2025-09-27T18:34:52.523067905Z     |     await self.simple_response(scope, receive, send, request_headers=headers)
2025-09-27T18:34:52.523070616Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
2025-09-27T18:34:52.523073156Z     |     await self.app(scope, receive, send)
2025-09-27T18:34:52.523075746Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
2025-09-27T18:34:52.523093346Z     |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-09-27T18:34:52.523096426Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:52.523099156Z     |     raise exc
2025-09-27T18:34:52.523101496Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:52.523103976Z     |     await app(scope, receive, sender)
2025-09-27T18:34:52.523106537Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
2025-09-27T18:34:52.523115677Z     |     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:52.523118307Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
2025-09-27T18:34:52.523120777Z     |     await route.handle(scope, receive, send)
2025-09-27T18:34:52.523123107Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
2025-09-27T18:34:52.523125487Z     |     await self.app(scope, receive, send)
2025-09-27T18:34:52.523128007Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
2025-09-27T18:34:52.523130407Z     |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-09-27T18:34:52.523132967Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:52.523135477Z     |     raise exc
2025-09-27T18:34:52.523137947Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:52.523140477Z     |     await app(scope, receive, sender)
2025-09-27T18:34:52.523143067Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
2025-09-27T18:34:52.523145678Z     |     response = await f(request)
2025-09-27T18:34:52.523148527Z     |                ^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523151118Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 297, in app
2025-09-27T18:34:52.523153578Z     |     async with AsyncExitStack() as async_exit_stack:
2025-09-27T18:34:52.523155808Z     |                ~~~~~~~~~~~~~~^^
2025-09-27T18:34:52.523158178Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 768, in __aexit__
2025-09-27T18:34:52.523160678Z     |     raise exc
2025-09-27T18:34:52.523163108Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 751, in __aexit__
2025-09-27T18:34:52.523165658Z     |     cb_suppress = await cb(*exc_details)
2025-09-27T18:34:52.523168038Z     |                   ^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523170448Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 221, in __aexit__
2025-09-27T18:34:52.523173118Z     |     await anext(self.gen)
2025-09-27T18:34:52.523175658Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/concurrency.py", line 37, in contextmanager_in_threadpool
2025-09-27T18:34:52.523178248Z     |     await anyio.to_thread.run_sync(
2025-09-27T18:34:52.523180828Z     |         cm.__exit__, None, None, None, limiter=exit_limiter
2025-09-27T18:34:52.523183239Z     |     )
2025-09-27T18:34:52.523185899Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/to_thread.py", line 56, in run_sync
2025-09-27T18:34:52.523188709Z     |     return await get_async_backend().run_sync_in_worker_thread(
2025-09-27T18:34:52.523192649Z     |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523195109Z     |         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
2025-09-27T18:34:52.523197679Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523200229Z     |     )
2025-09-27T18:34:52.523202729Z     |     ^
2025-09-27T18:34:52.523205319Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2485, in run_sync_in_worker_thread
2025-09-27T18:34:52.523208069Z     |     return await future
2025-09-27T18:34:52.523216039Z     |            ^^^^^^^^^^^^
2025-09-27T18:34:52.52321884Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 976, in run
2025-09-27T18:34:52.523221529Z     |     result = context.run(func, *args)
2025-09-27T18:34:52.523224109Z     |   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 148, in __exit__
2025-09-27T18:34:52.5232269Z     |     next(self.gen)
2025-09-27T18:34:52.52322961Z     |     ~~~~^^^^^^^^^^
2025-09-27T18:34:52.52323204Z     |   File "/opt/render/project/src/backend/src/database/deps.py", line 66, in get_db
2025-09-27T18:34:52.52323484Z     |     db.commit()
2025-09-27T18:34:52.52323736Z     |     ~~~~~~~~~^^
2025-09-27T18:34:52.52324006Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
2025-09-27T18:34:52.52324255Z     |     trans.commit(_to_root=True)
2025-09-27T18:34:52.52324516Z     |     ~~~~~~~~~~~~^^^^^^^^^^^^^^^
2025-09-27T18:34:52.52324777Z     |   File "<string>", line 2, in commit
2025-09-27T18:34:52.52325034Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
2025-09-27T18:34:52.52325288Z     |     self._raise_for_prerequisite_state(fn.__name__, current_state)
2025-09-27T18:34:52.523263631Z     |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523266551Z     |   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
2025-09-27T18:34:52.523269331Z     |     raise sa_exc.PendingRollbackError(
2025-09-27T18:34:52.523271991Z     |     ...<6 lines>...
2025-09-27T18:34:52.523274391Z     |     )
2025-09-27T18:34:52.523279031Z     | sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092"
2025-09-27T18:34:52.523281521Z     | LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:52.523284151Z     |                                                              ^
2025-09-27T18:34:52.523286691Z     | 
2025-09-27T18:34:52.523289981Z     | [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:52.523293891Z     | [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183452Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:52.523296422Z     | (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)
2025-09-27T18:34:52.523298942Z     +------------------------------------
2025-09-27T18:34:52.523301342Z 
2025-09-27T18:34:52.523309652Z During handling of the above exception, another exception occurred:
2025-09-27T18:34:52.523312062Z 
2025-09-27T18:34:52.523314552Z Traceback (most recent call last):
2025-09-27T18:34:52.523317152Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
2025-09-27T18:34:52.523319462Z     result = await app(  # type: ignore[func-returns-value]
2025-09-27T18:34:52.523322152Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523324752Z         self.scope, self.receive, self.send
2025-09-27T18:34:52.523327342Z         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523329872Z     )
2025-09-27T18:34:52.523332343Z     ^
2025-09-27T18:34:52.523335392Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
2025-09-27T18:34:52.523337912Z     return await self.app(scope, receive, send)
2025-09-27T18:34:52.523340363Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523343183Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1082, in __call__
2025-09-27T18:34:52.523345673Z     await super().__call__(scope, receive, send)
2025-09-27T18:34:52.523347973Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
2025-09-27T18:34:52.523350383Z     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:52.523352943Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
2025-09-27T18:34:52.523355363Z     raise exc
2025-09-27T18:34:52.523357893Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
2025-09-27T18:34:52.523360343Z     await self.app(scope, receive, _send)
2025-09-27T18:34:52.523362753Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 182, in __call__
2025-09-27T18:34:52.523365283Z     with recv_stream, send_stream, collapse_excgroups():
2025-09-27T18:34:52.523367913Z                                    ~~~~~~~~~~~~~~~~~~^^
2025-09-27T18:34:52.523370504Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 162, in __exit__
2025-09-27T18:34:52.523373113Z     self.gen.throw(value)
2025-09-27T18:34:52.523375544Z     ~~~~~~~~~~~~~~^^^^^^^
2025-09-27T18:34:52.523378004Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
2025-09-27T18:34:52.523380284Z     raise exc
2025-09-27T18:34:52.523382674Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 184, in __call__
2025-09-27T18:34:52.523385034Z     response = await self.dispatch_func(request, call_next)
2025-09-27T18:34:52.523387544Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523399064Z   File "/opt/render/project/src/backend/src/main.py", line 90, in add_security_headers
2025-09-27T18:34:52.523402044Z     response = await call_next(request)
2025-09-27T18:34:52.523404564Z                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523407874Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 159, in call_next
2025-09-27T18:34:52.523410465Z     raise app_exc
2025-09-27T18:34:52.523412794Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
2025-09-27T18:34:52.523415105Z     await self.app(scope, receive_or_disconnect, send_no_error)
2025-09-27T18:34:52.523422905Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
2025-09-27T18:34:52.523425465Z     await self.simple_response(scope, receive, send, request_headers=headers)
2025-09-27T18:34:52.523428005Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
2025-09-27T18:34:52.523430435Z     await self.app(scope, receive, send)
2025-09-27T18:34:52.523432955Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
2025-09-27T18:34:52.523435405Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-09-27T18:34:52.523438025Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:52.523440525Z     raise exc
2025-09-27T18:34:52.523442955Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:52.523445386Z     await app(scope, receive, sender)
2025-09-27T18:34:52.523447735Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
2025-09-27T18:34:52.523450175Z     await self.middleware_stack(scope, receive, send)
2025-09-27T18:34:52.523452656Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
2025-09-27T18:34:52.523455196Z     await route.handle(scope, receive, send)
2025-09-27T18:34:52.523457616Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
2025-09-27T18:34:52.523460366Z     await self.app(scope, receive, send)
2025-09-27T18:34:52.523463096Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
2025-09-27T18:34:52.523465646Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-09-27T18:34:52.523468176Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
2025-09-27T18:34:52.523470776Z     raise exc
2025-09-27T18:34:52.523473426Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
2025-09-27T18:34:52.523475996Z     await app(scope, receive, sender)
2025-09-27T18:34:52.523478506Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
2025-09-27T18:34:52.523481096Z     response = await f(request)
2025-09-27T18:34:52.523483487Z                ^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523485987Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 297, in app
2025-09-27T18:34:52.523488456Z     async with AsyncExitStack() as async_exit_stack:
2025-09-27T18:34:52.523490677Z                ~~~~~~~~~~~~~~^^
2025-09-27T18:34:52.523493067Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 768, in __aexit__
2025-09-27T18:34:52.523495407Z     raise exc
2025-09-27T18:34:52.523497827Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 751, in __aexit__
2025-09-27T18:34:52.523500387Z     cb_suppress = await cb(*exc_details)
2025-09-27T18:34:52.523502917Z                   ^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523505467Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 221, in __aexit__
2025-09-27T18:34:52.523508037Z     await anext(self.gen)
2025-09-27T18:34:52.523510587Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/fastapi/concurrency.py", line 37, in contextmanager_in_threadpool
2025-09-27T18:34:52.523517767Z     await anyio.to_thread.run_sync(
2025-09-27T18:34:52.523520647Z         cm.__exit__, None, None, None, limiter=exit_limiter
2025-09-27T18:34:52.523523197Z     )
2025-09-27T18:34:52.523525837Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/to_thread.py", line 56, in run_sync
2025-09-27T18:34:52.523528518Z     return await get_async_backend().run_sync_in_worker_thread(
2025-09-27T18:34:52.523531128Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523533708Z         func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter
2025-09-27T18:34:52.523536218Z         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523538858Z     )
2025-09-27T18:34:52.523541508Z     ^
2025-09-27T18:34:52.523544078Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 2485, in run_sync_in_worker_thread
2025-09-27T18:34:52.523546558Z     return await future
2025-09-27T18:34:52.523549208Z            ^^^^^^^^^^^^
2025-09-27T18:34:52.523551868Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 976, in run
2025-09-27T18:34:52.523554358Z     result = context.run(func, *args)
2025-09-27T18:34:52.523569779Z   File "/opt/render/project/python/Python-3.13.4/lib/python3.13/contextlib.py", line 148, in __exit__
2025-09-27T18:34:52.523576609Z     next(self.gen)
2025-09-27T18:34:52.523579079Z     ~~~~^^^^^^^^^^
2025-09-27T18:34:52.523581429Z   File "/opt/render/project/src/backend/src/database/deps.py", line 66, in get_db
2025-09-27T18:34:52.523583729Z     db.commit()
2025-09-27T18:34:52.523586089Z     ~~~~~~~~~^^
2025-09-27T18:34:52.523588449Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
2025-09-27T18:34:52.523590749Z     trans.commit(_to_root=True)
2025-09-27T18:34:52.523593349Z     ~~~~~~~~~~~~^^^^^^^^^^^^^^^
2025-09-27T18:34:52.523595819Z   File "<string>", line 2, in commit
2025-09-27T18:34:52.523598419Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
2025-09-27T18:34:52.52360087Z     self._raise_for_prerequisite_state(fn.__name__, current_state)
2025-09-27T18:34:52.52360343Z     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-09-27T18:34:52.5236059Z   File "/opt/render/project/src/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
2025-09-27T18:34:52.52360846Z     raise sa_exc.PendingRollbackError(
2025-09-27T18:34:52.52361099Z     ...<6 lines>...
2025-09-27T18:34:52.5236132Z     )
2025-09-27T18:34:52.52361584Z sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.InvalidTextRepresentation) invalid input syntax for type integer: "usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092"
2025-09-27T18:34:52.5236184Z LINE 1: ...nt_used, user_credits_id, usage_metadata) VALUES ('usage_bpR...
2025-09-27T18:34:52.52362086Z                                                              ^
2025-09-27T18:34:52.52362328Z 
2025-09-27T18:34:52.52362641Z [SQL: INSERT INTO usage_logs (id, user_id, usage_type, credits_used, product_count, language_code, category, tokens_used, response_time_ms, cost_usd, request_id, batch_id, endpoint_used, user_credits_id, usage_metadata) VALUES (%(id)s, %(user_id)s, %(usage_type)s, %(credits_used)s, %(product_count)s, %(language_code)s, %(category)s, %(tokens_used)s, %(response_time_ms)s, %(cost_usd)s, %(request_id)s, %(batch_id)s, %(endpoint_used)s, %(user_credits_id)s, %(usage_metadata)s::JSON) RETURNING usage_logs.created_at]
2025-09-27T18:34:52.52363474Z [parameters: {'id': 'usage_bpR6MB3823T20EK7BEa3cs2y22u2_1758998092', 'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_type': <UsageType.AI_GENERATION: 'ai_generation'>, 'credits_used': 1, 'product_count': 1, 'language_code': None, 'category': None, 'tokens_used': None, 'response_time_ms': None, 'cost_usd': None, 'request_id': None, 'batch_id': 'batch_20250927T183452Z', 'endpoint_used': 'single_description', 'user_credits_id': 'bpR6MB3823T20EK7BEa3cs2y22u2', 'usage_metadata': '{}'}]
2025-09-27T18:34:52.523637371Z (Background on this error at: https://sqlalche.me/e/20/9h9h) (Background on this error at: https://sqlalche.me/e/20/7s2a)