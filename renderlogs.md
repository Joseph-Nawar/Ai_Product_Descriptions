2025-09-28T17:09:02.175287855Z       },
2025-09-28T17:09:02.175290235Z       "checkout_data": {
2025-09-28T17:09:02.175292505Z         "email": "ziad321hussein@gmail.com",
2025-09-28T17:09:02.175294955Z         "name": "",
2025-09-28T17:09:02.175297285Z         "billing_address": [],
2025-09-28T17:09:02.175299755Z         "tax_number": "",
2025-09-28T17:09:02.175302015Z         "discount_code": "",
2025-09-28T17:09:02.175304535Z         "custom": {
2025-09-28T17:09:02.175306955Z           "user_id": "bpR6MB3823T20EK7BEa3cs2y22u2"
2025-09-28T17:09:02.175309416Z         },
2025-09-28T17:09:02.175311646Z         "variant_quantities": []
2025-09-28T17:09:02.175314316Z       },
2025-09-28T17:09:02.175316686Z       "preview": false,
2025-09-28T17:09:02.175319196Z       "expires_at": null,
2025-09-28T17:09:02.175321556Z       "created_at": "2025-09-28T17:09:02.000000Z",
2025-09-28T17:09:02.175324086Z       "updated_at": "2025-09-28T17:09:02.000000Z",
2025-09-28T17:09:02.175326746Z       "test_mode": true,
2025-09-28T17:09:02.175330016Z       "url": "https://product-genie.lemonsqueezy.com/checkout/custom/7498e5b8-31e2-4eec-a777-18b94d7c4b4e?signature=a615ff5278bab0118ac56cc773e4d558a62f3af2c85f0d4d5a0a0715ffb1564d"
2025-09-28T17:09:02.175332686Z     },
2025-09-28T17:09:02.175335096Z     "relationships": {
2025-09-28T17:09:02.175337556Z       "store": {
2025-09-28T17:09:02.175339836Z         "links": {
2025-09-28T17:09:02.175342896Z           "related": "https://api.lemonsqueezy.com/v1/checkouts/7498e5b8-31e2-4eec-a777-18b94d7c4b4e/store",
2025-09-28T17:09:02.175345736Z           "self": "https://api.lemonsqueezy.com/v1/checkouts/7498e5b8-31e2-4eec-a777-18b94d7c4b4e/relationships/store"
2025-09-28T17:09:02.175348036Z         }
2025-09-28T17:09:02.175350467Z       },
2025-09-28T17:09:02.175352707Z       "variant": {
2025-09-28T17:09:02.175355167Z         "links": {
2025-09-28T17:09:02.175357607Z           "related": "https://api.lemonsqueezy.com/v1/checkouts/7498e5b8-31e2-4eec-a777-18b94d7c4b4e/variant",
2025-09-28T17:09:02.175360237Z           "self": "https://api.lemonsqueezy.com/v1/checkouts/7498e5b8-31e2-4eec-a777-18b94d7c4b4e/relationships/variant"
2025-09-28T17:09:02.175367397Z         }
2025-09-28T17:09:02.175370247Z       }
2025-09-28T17:09:02.175372887Z     },
2025-09-28T17:09:02.175375637Z     "links": {
2025-09-28T17:09:02.175378677Z       "self": "https://api.lemonsqueezy.com/v1/checkouts/7498e5b8-31e2-4eec-a777-18b94d7c4b4e"
2025-09-28T17:09:02.175381537Z     }
2025-09-28T17:09:02.175384257Z   }
2025-09-28T17:09:02.175386737Z }
2025-09-28T17:09:02.175389348Z ✅ STEP 6 SUCCESS: Lemon Squeezy service call successful
2025-09-28T17:09:02.175393798Z Result: {'success': True, 'checkout_url': 'https://product-genie.lemonsqueezy.com/checkout/custom/7498e5b8-31e2-4eec-a777-18b94d7c4b4e?signature=a615ff5278bab0118ac56cc773e4d558a62f3af2c85f0d4d5a0a0715ffb1564d', 'checkout_id': '7498e5b8-31e2-4eec-a777-18b94d7c4b4e'}
2025-09-28T17:09:02.175396728Z INFO:     41.238.10.39:0 - "POST /api/payment/checkout HTTP/1.1" 200 OK
2025-09-28T17:09:02.2491306Z WARNING:src.payments.endpoints:🔍 No subscription found for user bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T17:09:02.251348144Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T17:09:02.25410159Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:02.394170546Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:02.835503975Z WARNING:src.payments.endpoints:🔍 No subscription found for user bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T17:09:02.837642497Z WARNING:src.payments.endpoints:User bpR6MB3823T20EK7BEa3cs2y22u2 has no subscription record, returning free tier
2025-09-28T17:09:02.840454185Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:02.960144608Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:04.779502689Z INFO:     connection closed
2025-09-28T17:09:38.463039694Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T17:09:38.462098+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T17:09:38.531238502Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T17:09:38.626952685Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '1997', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '9864d9831d9a5cd4-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': 'abf8c90f-2989-4ae3', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_payment_success', 'x-forwarded-for': '18.116.135.47, 104.23.243.81, 10.226.151.1', 'x-forwarded-proto': 'https', 'x-request-start': '1759079378454612', 'x-signature': '67c92fe4a346d5478f96bb45488ec47a5c9da0e36a822510bfc20f335c67a952'}
2025-09-28T17:09:38.626967965Z 🎯 BillingService: Processing webhook event_id=67c92fe4a346d5478f96bb45488ec47a5c9da0e36a822510bfc20f335c67a952
2025-09-28T17:09:38.626975076Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_payment_success', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'ebc76e8c-56dc-4c23-b9cd-3ed2dd1123be'}, 'data': {'type': 'subscription-invoices', 'id': '4587882', 'attributes': {'store_id': 224253, 'subscription_id': 1521298, 'customer_id': 6829303, 'user_name': 'Zeyad Sherif', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/21594274-9af3-4b77-b10d-c5c8f2690ba9/subscription-invoice/4587882?expires=1759100978&signature=c62694cfe421042bb3be4b9f36d3d2a8185b6a0d00b1fd1a0c175ec7086f3272'}, 'created_at': '2025-09-28T17:09:35.000000Z', 'updated_at': '2025-09-28T17:09:38.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587882/store', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587882/relationships/store'}}, 'subscription': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587882/subscription', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587882/relationships/subscription'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587882/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587882/relationships/customer'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscription-invoices/4587882'}}}
2025-09-28T17:09:38.626995506Z 🎯 BillingService: Event 67c92fe4a346d5478f96bb45488ec47a5c9da0e36a822510bfc20f335c67a952 is new, processing...
2025-09-28T17:09:38.627000746Z 🎯 BillingService: Event type: subscription_payment_success
2025-09-28T17:09:38.627052927Z 🎯 BillingService: Attributes: {'store_id': 224253, 'subscription_id': 1521298, 'customer_id': 6829303, 'user_name': 'Zeyad Sherif', 'user_email': 'ziad321hussein@gmail.com', 'billing_reason': 'initial', 'card_brand': 'visa', 'card_last_four': '4242', 'currency': 'USD', 'currency_rate': '1.00000000', 'status': 'paid', 'status_formatted': 'Paid', 'refunded': False, 'refunded_at': None, 'subtotal': 499, 'discount_total': 0, 'tax': 0, 'tax_inclusive': False, 'total': 499, 'refunded_amount': 0, 'subtotal_usd': 499, 'discount_total_usd': 0, 'tax_usd': 0, 'total_usd': 499, 'refunded_amount_usd': 0, 'subtotal_formatted': '$4.99', 'discount_total_formatted': '$0.00', 'tax_formatted': '$0.00', 'total_formatted': '$4.99', 'refunded_amount_formatted': '$0.00', 'urls': {'invoice_url': 'https://app.lemonsqueezy.com/my-orders/21594274-9af3-4b77-b10d-c5c8f2690ba9/subscription-invoice/4587882?expires=1759100978&signature=c62694cfe421042bb3be4b9f36d3d2a8185b6a0d00b1fd1a0c175ec7086f3272'}, 'created_at': '2025-09-28T17:09:35.000000Z', 'updated_at': '2025-09-28T17:09:38.000000Z', 'test_mode': True}
2025-09-28T17:09:38.627061908Z ✅ Using user_id: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T17:09:38.627065938Z 🎯 BillingService: Checking event type 'subscription_payment_success' against subscription events
2025-09-28T17:09:38.627069258Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=False
2025-09-28T17:09:38.627071888Z 🎯 Processing payment success event for user bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T17:09:38.627074718Z 🔧 Payment success: Using existing plan pro
2025-09-28T17:09:38.627077138Z ✅ Ensured user bpR6MB3823T20EK7BEa3cs2y22u2 exists in users table
2025-09-28T17:09:38.627080168Z 🔄 Updating existing subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: pro -> pro
2025-09-28T17:09:38.627082618Z ✅ Updated subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro, status=SubscriptionStatus.active
2025-09-28T17:09:38.627085148Z ✅ Updated Subscription table for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro
2025-09-28T17:09:38.627087618Z ✅ Created new UserSubscription for user bpR6MB3823T20EK7BEa3cs2y22u2: plan_id=pro
2025-09-28T17:09:38.627100968Z ✅ Updated subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro, status=active
2025-09-28T17:09:38.627103679Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 200 OK
2025-09-28T17:09:39.261586714Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T17:09:39.260627+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T17:09:39.296370944Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T17:09:39.32392061Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3394', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '9864d9883b9e9318-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': '755d22a4-3e31-41f9', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_created', 'x-forwarded-for': '18.116.135.47, 104.23.243.81, 10.226.151.1', 'x-forwarded-proto': 'https', 'x-request-start': '1759079379255803', 'x-signature': 'd53cba30dd62351f3e2021006ba3f1533bb6b4704aeb88d7a94cc7c805f57138'}
2025-09-28T17:09:39.32392597Z 🎯 BillingService: Processing webhook event_id=d53cba30dd62351f3e2021006ba3f1533bb6b4704aeb88d7a94cc7c805f57138
2025-09-28T17:09:39.32393524Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_created', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': 'e5da6010-4e00-4568-a671-8abb2190777b'}, 'data': {'type': 'subscriptions', 'id': '1521298', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492853, 'order_item_id': 6436688, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': 'Zeyad Sherif', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4515521, 'subscription_id': 1521298, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T17:09:39.000000Z', 'updated_at': '2025-09-28T17:09:39.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521298/payment-details?expires=1759100979&signature=2f595693afea4efecd7234019a0e94cbd89532e439d1d824c343c918fca44edd', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759100979&test_mode=1&user=5534177&signature=8cbb510ccda685550ddd78e1bf3a01ace9c4fda348be358c21b10f30786f923d', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521298/update?expires=1759100979&user=5534177&signature=0663822e23697c43e0f6897b7e4c2b4c3ecf0544861a6d50583e865c56b7a694'}, 'renews_at': '2025-10-28T17:09:30.000000Z', 'ends_at': None, 'created_at': '2025-09-28T17:09:31.000000Z', 'updated_at': '2025-09-28T17:09:36.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298'}}}
2025-09-28T17:09:39.323955701Z 🎯 BillingService: Event d53cba30dd62351f3e2021006ba3f1533bb6b4704aeb88d7a94cc7c805f57138 is new, processing...
2025-09-28T17:09:39.323959061Z 🎯 BillingService: Event type: subscription_created
2025-09-28T17:09:39.323971511Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492853, 'order_item_id': 6436688, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': 'Zeyad Sherif', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4515521, 'subscription_id': 1521298, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T17:09:39.000000Z', 'updated_at': '2025-09-28T17:09:39.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521298/payment-details?expires=1759100979&signature=2f595693afea4efecd7234019a0e94cbd89532e439d1d824c343c918fca44edd', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759100979&test_mode=1&user=5534177&signature=8cbb510ccda685550ddd78e1bf3a01ace9c4fda348be358c21b10f30786f923d', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521298/update?expires=1759100979&user=5534177&signature=0663822e23697c43e0f6897b7e4c2b4c3ecf0544861a6d50583e865c56b7a694'}, 'renews_at': '2025-10-28T17:09:30.000000Z', 'ends_at': None, 'created_at': '2025-09-28T17:09:31.000000Z', 'updated_at': '2025-09-28T17:09:36.000000Z', 'test_mode': True}
2025-09-28T17:09:39.323975321Z ✅ Using user_id: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T17:09:39.323978542Z 🎯 BillingService: Checking event type 'subscription_created' against subscription events
2025-09-28T17:09:39.323981371Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T17:09:39.323984371Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T17:09:39.323986942Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T17:09:39.323990592Z 🔧 Mapped to plan: pro
2025-09-28T17:09:39.323993192Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T17:09:39.323995802Z ✅ Ensured user bpR6MB3823T20EK7BEa3cs2y22u2 exists in users table
2025-09-28T17:09:39.323998612Z 🔄 Updating existing subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: pro -> pro
2025-09-28T17:09:39.324001842Z ✅ Updated subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro, status=SubscriptionStatus.active
2025-09-28T17:09:39.324004242Z ✅ Updated Subscription table for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro
2025-09-28T17:09:39.324011692Z ✅ Updated UserSubscription table for user bpR6MB3823T20EK7BEa3cs2y22u2: plan_id=pro, status=active
2025-09-28T17:09:39.324014182Z ✅ Updated subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro, status=SubscriptionStatus.active
2025-09-28T17:09:39.324016712Z ✅ Committed subscription update to database
2025-09-28T17:09:39.324019552Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 200 OK
2025-09-28T17:09:41.353044721Z INFO:     41.238.10.39:0 - "WebSocket /ws/payments" [accepted]
2025-09-28T17:09:41.353288487Z INFO:     connection open
2025-09-28T17:09:41.585803727Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:41.755771635Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:41.828131233Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:41.95169115Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:42.117098177Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:42.196461926Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:42.373790071Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:42.552687295Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:49.399644982Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/plans HTTP/1.1" 200 OK
2025-09-28T17:09:49.56508672Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:49.567184761Z INFO:     41.238.10.39:0 - "GET /api/payment/plans HTTP/1.1" 200 OK
2025-09-28T17:09:49.709656684Z INFO:     41.238.10.39:0 - "OPTIONS /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:49.75751213Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:49.910947569Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:49.95612759Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:50.085164269Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:51.895451749Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:51.975191226Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:52.231420788Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:52.374856385Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:09:52.769349338Z INFO:     41.238.10.39:0 - "GET /api/payment/user/subscription HTTP/1.1" 200 OK
2025-09-28T17:09:52.910647963Z INFO:     41.238.10.39:0 - "GET /api/payment/user/credits HTTP/1.1" 200 OK
2025-09-28T17:10:08.721682222Z WARNING:security:{"event_type": "webhook_received", "user_id": null, "timestamp": "2025-09-28T17:10:08.718677+00:00", "ip_address": null, "user_agent": null, "event_data": {"signature_provided": true, "signature_valid": true}, "security_level": "high", "success": true, "error_message": null, "session_id": null, "correlation_id": null}
2025-09-28T17:10:08.988129101Z 🎯 WEBHOOK RECEIVED: POST https://ai-product-descriptions.onrender.com/api/payment/webhook
2025-09-28T17:10:08.988163072Z 🎯 WEBHOOK HEADERS: {'host': 'ai-product-descriptions.onrender.com', 'user-agent': 'LemonSqueezy-Hookshot', 'content-length': '3394', 'accept-encoding': 'gzip, br', 'cdn-loop': 'cloudflare; loops=1', 'cf-connecting-ip': '18.116.135.47', 'cf-ipcountry': 'US', 'cf-ray': '9864da403f2bcf7c-CMH', 'cf-visitor': '{"scheme":"https"}', 'content-type': 'application/json', 'render-proxy-ttl': '4', 'rndr-id': 'b4b5dede-fa61-4455', 'true-client-ip': '18.116.135.47', 'x-event-name': 'subscription_updated', 'x-forwarded-for': '18.116.135.47, 104.23.197.55, 10.226.169.130', 'x-forwarded-proto': 'https', 'x-request-start': '1759079408717085', 'x-signature': '556dcd7b8de04f23132c33a28957393b338559ac9781958ab365cb4ac85716b4'}
2025-09-28T17:10:08.988179682Z 🎯 BillingService: Processing webhook event_id=556dcd7b8de04f23132c33a28957393b338559ac9781958ab365cb4ac85716b4
2025-09-28T17:10:08.988187782Z 🎯 BillingService: Event data: {'meta': {'test_mode': True, 'event_name': 'subscription_updated', 'custom_data': {'user_id': 'bpR6MB3823T20EK7BEa3cs2y22u2'}, 'webhook_id': '21a69cc7-6e56-4280-aa9c-8de486a10c20'}, 'data': {'type': 'subscriptions', 'id': '1521298', 'attributes': {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492853, 'order_item_id': 6436688, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': 'Zeyad Sherif', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4515521, 'subscription_id': 1521298, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T17:09:39.000000Z', 'updated_at': '2025-09-28T17:10:08.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521298/payment-details?expires=1759101008&signature=8b7792216f26f8ce2058a23e9db7e8ba41855160aa34d4f29819ed0e8bc739e7', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759101008&test_mode=1&user=5534177&signature=2ca15ee5c216c822fe32883ebde01364dd1a7cf89188cf743ef562cfc70db05c', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521298/update?expires=1759101008&user=5534177&signature=b0e4e7324e95b2343d58764e9b8a62fbcc7517489795ffd394fb6b830db67234'}, 'renews_at': '2025-10-28T17:09:30.000000Z', 'ends_at': None, 'created_at': '2025-09-28T17:09:31.000000Z', 'updated_at': '2025-09-28T17:09:36.000000Z', 'test_mode': True}, 'relationships': {'store': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/store', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/store'}}, 'customer': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/customer', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/customer'}}, 'order': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/order', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/order'}}, 'order-item': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/order-item', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/order-item'}}, 'product': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/product', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/product'}}, 'variant': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/variant', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/variant'}}, 'subscription-items': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/subscription-items', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/subscription-items'}}, 'subscription-invoices': {'links': {'related': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/subscription-invoices', 'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298/relationships/subscription-invoices'}}}, 'links': {'self': 'https://api.lemonsqueezy.com/v1/subscriptions/1521298'}}}
2025-09-28T17:10:08.988191182Z 🎯 BillingService: Event 556dcd7b8de04f23132c33a28957393b338559ac9781958ab365cb4ac85716b4 is new, processing...
2025-09-28T17:10:08.988199943Z 🎯 BillingService: Event type: subscription_updated
2025-09-28T17:10:08.988206473Z 🎯 BillingService: Attributes: {'store_id': 224253, 'customer_id': 6829303, 'order_id': 6492853, 'order_item_id': 6436688, 'product_id': 645534, 'variant_id': 1013286, 'product_name': 'Get Extra Product Descriptions', 'variant_name': 'Pro Plan', 'user_name': 'Zeyad Sherif', 'user_email': 'ziad321hussein@gmail.com', 'status': 'active', 'status_formatted': 'Active', 'card_brand': 'visa', 'card_last_four': '4242', 'payment_processor': 'stripe', 'pause': None, 'cancelled': False, 'trial_ends_at': None, 'billing_anchor': 28, 'first_subscription_item': {'id': 4515521, 'subscription_id': 1521298, 'price_id': 1608947, 'quantity': 1, 'is_usage_based': False, 'created_at': '2025-09-28T17:09:39.000000Z', 'updated_at': '2025-09-28T17:10:08.000000Z'}, 'urls': {'update_payment_method': 'https://product-genie.lemonsqueezy.com/subscription/1521298/payment-details?expires=1759101008&signature=8b7792216f26f8ce2058a23e9db7e8ba41855160aa34d4f29819ed0e8bc739e7', 'customer_portal': 'https://product-genie.lemonsqueezy.com/billing?expires=1759101008&test_mode=1&user=5534177&signature=2ca15ee5c216c822fe32883ebde01364dd1a7cf89188cf743ef562cfc70db05c', 'customer_portal_update_subscription': 'https://product-genie.lemonsqueezy.com/billing/1521298/update?expires=1759101008&user=5534177&signature=b0e4e7324e95b2343d58764e9b8a62fbcc7517489795ffd394fb6b830db67234'}, 'renews_at': '2025-10-28T17:09:30.000000Z', 'ends_at': None, 'created_at': '2025-09-28T17:09:31.000000Z', 'updated_at': '2025-09-28T17:09:36.000000Z', 'test_mode': True}
2025-09-28T17:10:08.988210553Z ✅ Using user_id: bpR6MB3823T20EK7BEa3cs2y22u2
2025-09-28T17:10:08.988213323Z 🎯 BillingService: Checking event type 'subscription_updated' against subscription events
2025-09-28T17:10:08.988217333Z 🎯 BillingService: is_subscription_event=True, has_subscription_data=True
2025-09-28T17:10:08.988219973Z 🔧 Mapping variant_id: 1013286 (type: <class 'int'>)
2025-09-28T17:10:08.988222293Z 🔧 Available mappings: {'1013286': 'pro', '1013276': 'enterprise', '1013282': 'pro-yearly'}
2025-09-28T17:10:08.988225353Z 🔧 Mapped to plan: pro
2025-09-28T17:10:08.988228243Z 🔧 Mapped variant_id 1013286 to plan: pro
2025-09-28T17:10:08.988230974Z ✅ Ensured user bpR6MB3823T20EK7BEa3cs2y22u2 exists in users table
2025-09-28T17:10:08.988233843Z 🔄 Updating existing subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: pro -> pro
2025-09-28T17:10:08.988237194Z ✅ Updated subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro, status=SubscriptionStatus.active
2025-09-28T17:10:08.988239844Z ✅ Updated Subscription table for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro
2025-09-28T17:10:08.988241624Z ✅ Updated UserSubscription table for user bpR6MB3823T20EK7BEa3cs2y22u2: plan_id=pro, status=active
2025-09-28T17:10:08.988243394Z ✅ Updated subscription for user bpR6MB3823T20EK7BEa3cs2y22u2: plan=pro, status=SubscriptionStatus.active
2025-09-28T17:10:08.988245074Z ✅ Committed subscription update to database
2025-09-28T17:10:08.988246944Z INFO:     18.116.135.47:0 - "POST /api/payment/webhook HTTP/1.1" 200 OK